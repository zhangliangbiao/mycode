<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.isz.erp.house.mapper.ResidentialBuildingFloorMapper">

    <!-- 批量保存楼层信息 -->
	<insert id="saveFloorBatch" parameterType="java.util.List">
	    INSERT INTO `residential_building_floor` 
			(`floor_id`, `building_id`, `floor_name`, `sort`, `create_time`, `create_uid`, 
			`update_time`, `update_uid`,`city_code`,`area_code`)
		VALUES
        <foreach collection="list" item="item" index="index" separator="," >  
     	   (#{item.floor_id},#{item.building_id},#{item.floor_name},#{item.sort},now(),#{item.create_uid},
			now(),#{item.update_uid},#{item.city_code},#{item.area_code})
   		</foreach> 
	</insert>
	
	<!-- 根据楼栋id查询楼层信息 -->
	<select id="selectList" parameterType="java.lang.String" resultType="com.isz.erp.facade.house.entity.ResidentialBuildingFloor">
	   select r.floor_id,r.building_id,r.unit_id,u.unit_name,r.floor_name,r.sort,r.create_time,r.create_uid,r.update_time,r.update_uid
	   from  residential_building_floor r 
			LEFT JOIN residential_building_unit u 
   		on r.unit_id=u.unit_id 
  		where r.building_id = #{building_id};
	</select>
	
	<!-- 更新单元信息-->
	<update id="updateFloorBatch" parameterType="java.util.List">
	    <foreach collection="list" item="item" index="index" open="" close="" separator=";">  
            UPDATE residential_building_floor   
                <set>
                   <if test="item.building_id != null">
                       building_id=#{item.building_id},
                   </if>
                   <if test="item.floor_name != null">
                       floor_name = #{item.floor_name}
                   </if>
                   <if test="item.sort != null">
                       sort=#{item.sort} 
                   </if>
                   <if test="item.update_uid != null">
                       update_uid=#{item.update_uid} 
                   </if>
                   update_time = now()
                </set>
                where floor_id = #{item.floor_id}  
         </foreach>  
	</update>
	
	<delete id="deleteFloorByBuildingId" parameterType="java.lang.String">
	    delete from residential_building_floor where building_id = #{building_id}
	</delete>

	<select id="selectListByMap" parameterType="java.util.Map" resultType="java.util.Map">
		select tt.* from (
			select rbf.floor_id,rbf.floor_name,rbf.unit_id
			from
			residential_building_floor rbf
			where rbf.unit_id IS NOT NULL AND rbf.unit_id != ''
			AND rbf.building_id = #{building_id}
			AND rbf.unit_id=#{unit_id}
			UNION
			select rbf.floor_id,rbf.floor_name,rbf.unit_id
			from
			residential_building_floor rbf
			where (rbf.unit_id IS NULL OR rbf.unit_id = '')
			AND rbf.building_id = #{building_id}
		) tt group by tt.floor_name order by tt.floor_name
	</select>

	<delete id="deleteFloorByFloorIds" parameterType="java.lang.String">
		delete from residential_building_floor where floor_id in (${floor_id_delete})
	</delete>

	<delete id="deleteByUnitIds" parameterType="java.lang.String">
		delete from residential_building_floor where unit_id in (${unit_id_delete})
	</delete>

	<select id="searchBuildingFloorList" parameterType="java.util.Map" resultType="com.isz.erp.facade.house.entity.ResidentialBuildingFloor">
		SELECT rbf.*,(SELECT COUNT(1) FROM residential_building_house_no WHERE floor_id=rbf.floor_id AND unit_id=rbf.unit_id AND rbf.building_id=rbf.building_id) house_no_num FROM residential_building_floor rbf WHERE rbf.building_id=#{building_id} AND rbf.unit_id=#{unit_id} ORDER BY rbf.floor_name
	</select>
	
	<select id="countSearchBuildingFloor" parameterType="java.util.Map" resultType="java.lang.Integer">
		SELECT COUNT(1) FROM residential_building_floor WHERE building_id=#{building_id} AND unit_id=#{unit_id}
	</select>

	<select id="selectByMap" parameterType="java.util.Map" resultType="com.isz.erp.facade.house.entity.ResidentialBuildingFloor">
		SELECT * FROM residential_building_floor WHERE building_id=#{building_id} AND unit_id=#{unit_id} AND floor_name=#{floor_name}
	</select>
</mapper>