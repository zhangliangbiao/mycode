<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.isz.erp.house.mapper.HouseImgMapper">
	<!-- resultMap -->
	<resultMap id="HouseImgBaseMap" type="com.isz.erp.facade.house.entity.HouseImg">
	    <id column="house_img_id" property="house_img_id"/>
	    <result column="residential_id" property="residential_id"/>
	    <result column="building_id" property="building_id"/>
	    <result column="house_id" property="house_id"/>
	    <result column="img_id" property="img_id"/>
	    <result column="img_name" property="img_name"/>
	    <result column="img_type" property="img_type"/>
	     <result column="img_sub_type" property="img_sub_type"/>
	    
	    <result column="src" property="src"/>
	    <result column="audit_status" property="audit_status"/>
	    <result column="audit_time" property="audit_time"/>
	    <result column="audit_uid" property="audit_uid"/>
	    <result column="deleted" property="deleted"/>
	    <result column="sort" property="sort"/>
	    <result column="create_time" property="create_time"/>
	    <result column="create_uid" property="create_uid"/>
	    <result column="create_user" property="create_user"/>
	    <result column="create_dep" property="create_dep"/>
 	</resultMap>
 	
 	<!-- 批量插入房屋图片信息 -->
	<insert id="saveHouseImg" parameterType="java.util.List">
		INSERT INTO `house_img` 
			(`house_img_id`,`residential_id`, `building_id`, `house_id`, `img_id`, `img_name`, `img_type`,
			`audit_status`, `audit_time`, `audit_uid`, `deleted`,`sort`, `create_time`, `create_uid`)
		VALUES
        <foreach collection="list" item="item" index="index" separator="," >  
     	   (#{item.house_img_id},#{item.residential_id},#{item.building_id},#{item.house_id},#{item.img_id},#{item.img_name},#{item.img_type},
     	  	#{item.audit_status},#{item.audit_time},#{item.audit_uid},#{item.deleted},#{item.sort},#{item.create_time},#{item.create_uid})  
   		</foreach>  
  	</insert>
  	<!-- 删除当前房屋下的所有图片信息 -->
  	<delete id="deleteByHouseId" parameterType="java.lang.String">
  		UPDATE `house_img` SET `deleted`=1 WHERE `house_id`=#{house_id}
  	</delete>
  	<!-- 新增单个图片 -->
  	<insert id="insertHouseImg" parameterType="com.isz.erp.facade.house.entity.HouseImg">
  		INSERT INTO `house_img` 
			(`house_img_id`,`residential_id`, `building_id`, `house_id`, `img_id`, `img_name`, `img_type`,
			`img_sub_type`,`is_first_exploration`,
			`audit_status`, `audit_time`, `audit_uid`, `deleted`, `sort`,`create_time`, `create_uid`)
		VALUES
			(#{house_img_id},#{residential_id},#{building_id},#{house_id},#{img_id},#{img_name},#{img_type},
			#{img_sub_type},#{is_first_exploration},
			#{audit_status},#{audit_time},#{audit_uid},#{deleted},#{sort},now(),#{create_uid})
  	</insert>
  	<!-- 删除单个图片 -->
  	<delete id="deleteByHouseImgId" parameterType="java.lang.String">
  		UPDATE `house_img` SET `deleted`=1 WHERE `house_img_id`=#{house_img_id}
  	</delete>
  	<!-- 符合条件的房屋图片列表 -->
  	<select id="searchHouseImgList" parameterType="java.util.Map" resultMap="HouseImgBaseMap">
  		SELECT
			i.house_img_id,i.residential_id,i.building_id,i.house_id,i.img_id,i.img_name,i.img_type,i.img_sub_type,
			i.audit_status,i.audit_time,i.audit_uid,i.deleted,i.create_time,i.create_uid,su.dep_id as create_did,
			ie.src,i.sort,su.user_name as create_user,sd.dep_name as create_dep
		FROM
			house_img AS i
		INNER JOIN image ie ON i.img_id=ie.img_id
		LEFT JOIN sys_user su on i.create_uid = su.user_id
		LEFT JOIN sys_department sd on sd.dep_id = su.dep_id
		WHERE
			i.deleted=0 AND ie.deleted=0
			<if test="null != house_id">
				AND i.house_id=#{house_id}
			</if>
			<if test="null != img_name">
				AND i.img_name LIKE CONCAT('%',#{img_name},'%')
			</if>
		ORDER BY IF(ISNULL(i.sort),1,0),i.sort ASC;
  	</select>
  	<!-- 符合条件的房屋图片列表记录总数-->
  	<select id="countSearchHouseImg" parameterType="java.util.Map" resultType="java.lang.Integer">
  		SELECT
			COUNT(i.house_img_id)
		FROM
			house_img AS i
		WHERE
			i.deleted=0
			<if test="null != house_id">
				AND i.house_id=#{house_id}
			</if>
			<if test="null != img_name">
				AND i.img_name LIKE CONCAT('%',#{img_name},'%')
			</if>
  	</select>
  	<!-- 更新图片状态 -->
  	<update id="updateHouseImg" parameterType="com.isz.erp.facade.house.entity.HouseImg">
  		UPDATE `house_img` SET `img_name`=#{img_name},`img_type`=#{img_type},
  		`submit_audit_time`=#{submit_audit_time},`img_type`=#{img_type},
  		`audit_status`=#{audit_status}, `audit_time`=#{audit_time}, `audit_uid`=#{audit_uid}
  		WHERE `house_img_id`=#{house_img_id}
  	</update>
  	<!-- 返回单个图片信息 -->
  	<select id="selectByHouseImgId" parameterType="java.lang.String" resultMap="HouseImgBaseMap">
  		SELECT
			hi.house_img_id,hi.residential_id,hi.building_id,hi.house_id,hi.img_id,hi.img_name,hi.img_type,
			hi.audit_status,hi.audit_time,hi.audit_uid,hi.deleted,hi.sort,hi.create_time,hi.create_uid
		FROM
			house_img AS hi
		WHERE
			hi.deleted=0 AND hi.house_img_id=#{house_img_id}
  	</select>
  	<!-- 返回出租房屋的配套设施列表 -->
  	<select id="selectListByHouseId" parameterType="java.lang.String" resultMap="HouseImgBaseMap">
  		SELECT
			hi.house_img_id,hi.residential_id,hi.building_id,hi.house_id,hi.img_id,hi.img_name,hi.img_type,hi.img_sub_type,
			hi.audit_status,hi.audit_time,hi.audit_uid,hi.deleted,hi.create_time,hi.create_uid,
			i.src,hi.sort,su.user_name as create_user,sd.dep_name as create_dep
		FROM
			house_img AS hi
		INNER JOIN image i ON hi.img_id=i.img_id
		LEFT JOIN sys_user su on hi.create_uid = su.user_id
		LEFT JOIN sys_department sd on sd.dep_id = su.dep_id
		WHERE
  			hi.deleted=0 AND i.deleted=0 AND hi.`house_id`=#{house_id}
		ORDER BY IF(ISNULL(hi.sort),1,0),hi.sort ASC;
  	</select>
</mapper>