<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.isz.erp.house.mapper.HouseAuditStatusChangeMapper">
	
	<select id="selectByHouseId" parameterType="map" resultType="com.isz.erp.facade.house.entity.HouseAuditStatusChange">
			select * from house_audit_status_change where house_id=#{house_id} and audit_status='NO_AUDIT' and deleted=0
	</select>
	
	<select id="selectByChangeId" parameterType="String" resultType="com.isz.erp.facade.house.entity.HouseAuditStatusChange">
			select * from house_audit_status_change where change_id=#{change_id}
	</select>
	
	
	<select id="selectHouseStatusChangeList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT 
			hasc.change_id,
			hasc.house_id,
			hasc.now_house_status,
			hasc.apply_change_status,
			hasc.save_change_status,
			hasc.category,
			hasc.lease_type,
			hasc.his_rent_date,
			hasc.apply_remark,
			hasc.audit_uid,
			hasc.audit_date,
			hasc.audit_status,
			hasc.audit_remark,
			hasc.create_time,
			hasc.create_uid,
			hasc.update_time,
			hasc.update_uid,
			h.property_name,
			r.residential_name,
			rb.building_name,
			su.user_name as create_user_name,
			sd.dep_name as create_dep_name, 
			bc.business_circle_name,
			sdt.name as area_name,
			su2.user_name as audit_user_name,
			sd2.dep_name as audit_dep_name
			from 
			house_audit_status_change hasc 
			INNER JOIN house h ON (h.house_id=hasc.house_id and h.deleted=0)
			inner JOIN residential r on(h.residential_id=r.residential_id)
			inner JOIN residential_building rb on(rb.residential_id=r.residential_id and h.building_id=rb.building_id)
			LEFT JOIN residential_business_circle rbc on(h.residential_id=rbc.residential_id)
			LEFT JOIN business_circle bc on(bc.business_circle_id=rbc.business_circle_id)
			LEFT JOIN sys_district sdt on(sdt.code=h.area_code) 
			LEFT JOIN sys_user su ON su.user_id = hasc.create_uid
			LEFT JOIN sys_department sd ON sd.dep_id=su.dep_id
			LEFT JOIN sys_user su2 ON su2.user_id = hasc.audit_uid
			LEFT JOIN sys_department sd2 ON sd2.dep_id=su2.dep_id 
			where hasc.deleted=0  
				<if test="null != change_id and '' != change_id">and hasc.change_id=#{change_id}</if>
				<if test="null != city_code_search and '' != city_code_search">and h.house_id in(select house_id from house where city_code=#{city_code_search})</if>
				<if test="null != area_code_search and '' != area_code_search">and h.area_code in (${area_code_search})</if>
				<if test="null != business_circle_id_search and '' != business_circle_id_search">and rbc.business_circle_id in (${business_circle_id_search})</if>
				<!-- 申请部门 -->
				<if test="null != did_search and '' != did_search and (null == uid_search or '' == uid_search)">
					and EXISTS (select 1 from sys_department_flat t where t.child_id=su.dep_id and t.dept_id in (${did_search}))
				</if>
				<if test="null != uid_search and '' != uid_search">and hasc.create_uid in (${uid_search})</if>
				<if test="null != user_name_search and '' != user_name_search">and su.user_name like CONCAT('%','${user_name_search}','%' )</if>
				<if test="null != house_status_search and '' != house_status_search">and h.house_status in (${house_status_search})</if>
				<if test="null != audit_status_search and '' != audit_status_search">and hasc.audit_status in (${audit_status_search})</if>
				<if test="null != residential_name_search and '' != residential_name_search">and (r.residential_name like '%${residential_name_search}%')</if>
				<if test="null != create_time_start_search and '' != create_time_start_search"><![CDATA[and date(hasc.create_time) >= #{create_time_start_search}]]></if>
				<if test="null != create_time_end_search and '' != create_time_end_search"><![CDATA[and date(hasc.create_time) <= #{create_time_end_search}]]></if>
				<if test="null != audit_time_start_search and '' != audit_time_start_search"><![CDATA[and date(hasc.audit_date) >= #{audit_time_start_search}]]></if>
				<if test="null != audit_time_end_search and '' != audit_time_end_search"><![CDATA[and date(hasc.audit_date) <= #{audit_time_end_search}]]></if>
				<if test="null != audit_name_search and '' != audit_name_search"><![CDATA[and hasc.audit_uid in (select user_id from sys_user where user_name like CONCAT('%','${audit_name_search}','%' ))]]></if>
				<if test="null != audit_context_search and '' != audit_context_search">and hasc.audit_remark like CONCAT('%','${audit_context_search}','%' )</if>
				<if test="null != building_name_search and '' != building_name_search">
					AND rb.building_name LIKE CONCAT('%',#{building_name_search},'%')
				</if>
				<if test="null != unit_search and '' != unit_search">
					AND h.unit LIKE CONCAT('%',#{unit_search},'%')
				</if>
				<if test="null != house_no_search and '' != house_no_search">
					AND h.house_no LIKE CONCAT('%',#{house_no_search},'%')
				</if>
				<if test="null != uid_name_search and '' != uid_name_search">
					AND su.user_name LIKE CONCAT('%',#{uid_name_search},'%')
				</if>
				order by hasc.update_time desc 
	</select>
	
	<select id="selectHouseStatusChangeListCount" parameterType="java.util.Map" resultType="int">
		SELECT 
			count(hasc.change_id)
			from 
			(SELECT * from house_audit_status_change where audit_status='NO_AUDIT') hasc
			INNER JOIN house h ON (h.house_id=hasc.house_id and h.deleted=0)
			inner JOIN residential r on(h.residential_id=r.residential_id)
			inner JOIN residential_building rb on(rb.residential_id=r.residential_id and h.building_id=rb.building_id)
			LEFT JOIN residential_business_circle rbc on(h.residential_id=rbc.residential_id)
			LEFT JOIN business_circle bc on(bc.business_circle_id=rbc.business_circle_id)
			LEFT JOIN sys_district sdt on(sdt.code=h.area_code) 
			LEFT JOIN sys_user su ON su.user_id = hasc.create_uid
			LEFT JOIN sys_department sd ON sd.dep_id=su.dep_id
			LEFT JOIN sys_user su2 ON su2.user_id = hasc.audit_uid
			LEFT JOIN sys_department sd2 ON sd2.dep_id=su2.dep_id 
			where hasc.deleted=0  
			<if test="null != city_code_search and '' != city_code_search">and h.house_id in(select house_id from house where city_code=#{city_code_search})</if>
				<if test="null != area_code_search and '' != area_code_search">and h.area_code in (${area_code_search})</if>
				<if test="null != business_circle_id_search and '' != business_circle_id_search">and rbc.business_circle_id in (${business_circle_id_search})</if>
				<!-- 申请部门 -->
				<if test="null != did_search and '' != did_search and (null == uid_search or '' == uid_search)">
					and EXISTS (select 1 from sys_department_flat t where t.child_id=su.dep_id and t.dept_id in (${did_search}))
				</if>
				<if test="null != uid_search and '' != uid_search">and hasc.create_uid in (${uid_search})</if>
				<if test="null != user_name_search and '' != user_name_search">and su.user_name like CONCAT('%','${user_name_search}','%' )</if>
				<if test="null != house_status_search and '' != house_status_search">and h.house_status in (${house_status_search})</if>
				<if test="null != audit_status_search and '' != audit_status_search">and hasc.audit_status in (${audit_status_search})</if>
				<if test="null != residential_name_search and '' != residential_name_search">and (r.residential_name like '%${residential_name_search}%')</if>
				<if test="null != create_time_start_search and '' != create_time_start_search"><![CDATA[and date(hasc.create_time) >= #{create_time_start_search}]]></if>
				<if test="null != create_time_end_search and '' != create_time_end_search"><![CDATA[and date(hasc.create_time) <= #{create_time_end_search}]]></if>
				<if test="null != audit_time_start_search and '' != audit_time_start_search"><![CDATA[and date(hasc.audit_date) >= #{audit_time_start_search}]]></if>
				<if test="null != audit_time_end_search and '' != audit_time_end_search"><![CDATA[and date(hasc.audit_date) <= #{audit_time_end_search}]]></if>
				<if test="null != audit_name_search and '' != audit_name_search"><![CDATA[and hasc.audit_uid in (select user_id from sys_user where user_name like CONCAT('%','${audit_name_search}','%' ))]]></if>
				<if test="null != audit_context_search and '' != audit_context_search">and hasc.audit_remark like CONCAT('%','${audit_context_search}','%' )</if>
				<if test="null != building_name_search and '' != building_name_search">
					AND rb.building_name LIKE CONCAT('%',#{building_name_search},'%')
				</if>
				<if test="null != unit_search and '' != unit_search">
					AND h.unit LIKE CONCAT('%',#{unit_search},'%')
				</if>
				<if test="null != house_no_search and '' != house_no_search">
					AND h.house_no LIKE CONCAT('%',#{house_no_search},'%')
				</if>
				<if test="null != uid_name_search and '' != uid_name_search">
					AND su.user_name LIKE CONCAT('%',#{uid_name_search},'%')
				</if>
	</select>
	
	
	<update id="deleteHouseStatusChangeById" parameterType="String">
		UPDATE house_audit_status_change set deleted=1 where change_id=#{change_id}
	</update>
	
	<select id="selectHouseStatusChangeCountByHouseId" parameterType="String" resultType="int">
		SELECT COUNT(change_id) from house_audit_status_change where house_id=#{0} and deleted=0 and audit_status='NO_AUDIT' 
	</select>
	
	<update id="updateHouseAuditStatusChangeById" parameterType="com.isz.erp.facade.house.entity.HouseAuditStatusChange">
		UPDATE house_audit_status_change 
		set 
			house_id=#{house_id},
			now_house_status=#{now_house_status},
			apply_change_status=#{apply_change_status},
			save_change_status=#{save_change_status},
			category=#{category},
			lease_type=#{lease_type},
			his_rent_date=#{his_rent_date},
			apply_remark=#{apply_remark},
			audit_uid=#{audit_uid},
			audit_date=#{audit_date},
			audit_status=#{audit_status},
			audit_remark=#{audit_remark},
			create_time=#{create_time},
			create_uid=#{create_uid},
			update_time=#{update_time},
			update_uid=#{update_uid},
			deleted=#{deleted} 
		where change_id=#{change_id}
	</update>
</mapper>