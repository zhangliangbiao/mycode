<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.isz.erp.house.mapper.ApartmentLogMapper">	
	<select id="searchApartmentListByLog" parameterType="java.util.Map" resultType="com.isz.erp.facede.bzlog.entity.ApartmentLog">
		select
		a.house_contract_id,
		a.room_id,
		hr.room_code,
		a.apartment_id,
		a.house_id,
		a.apartment_code,
		a.rent_type,
		a.rent_status,
		a.property,
		a.category,
		a.dealtype,
		a.fire_status,
		a.city_code,
		a.area_code,
		suu.dep_id did,
		a.uid,
		h.house_code,
		hr.room_no,
		hc.sign_uid,
		su.dep_id sign_did,
		su.user_name AS signusername,
		sysd.dep_name AS signdeptname,
		h.property_type,
		h.property_use,
		serviceu.user_name AS serviceusername,
		a.service_uid,
		serviceu.dep_id service_did,
		(SELECT
		d.name
		FROM
		sys_district d
		WHERE
		d.code = a.city_code) AS city_name,
		hc.payment_cycle,
		a.fire_days,
		CONCAT(r.residential_name,IFNULL(rb.building_name,''),IFNULL((select dict_value from sys_dict_item where dict_code='Suffix' AND dict_key=rb.suffix),''),CASE h.unit WHEN '无' THEN '' ELSE IFNULL(h.unit,'') END,IFNULL(h.house_no,''),'室') as house_address,
		CURDATE() log_time
		FROM
		apartment a

		JOIN residential r ON a.residential_id = r.residential_id
		JOIN residential_building rb ON a.building_id = rb.building_id
		JOIN house h ON a.house_id = h.house_id
		LEFT JOIN sys_district sd ON a.area_code = sd.code
		LEFT JOIN sys_district sd_city ON a.city_code = sd_city.code
		left JOIN house_room hr ON a.room_id = hr.room_id AND hr.deleted = 0 AND hr.is_active = 'Y'
		INNER JOIN house_contract hc ON hc.house_id = h.house_id
		AND hc.contract_id = a.house_contract_id
		AND hc.is_active = 'Y'
		AND hc.deleted = 0
		LEFT JOIN sys_user suu ON suu.user_id=a.uid
		LEFT JOIN sys_user su ON hc.sign_uid = su.user_id
		LEFT JOIN sys_department sysd ON su.dep_id = sysd.dep_id
		LEFT JOIN sys_user serviceu ON serviceu.user_id = a.service_uid
		LEFT JOIN sys_department syss ON syss.dep_id = serviceu.dep_id
		LEFT JOIN fitment_house fh ON fh.house_id = hc.house_id AND fh.contract_id = hc.contract_id
		LEFT JOIN sys_user su1 ON a.web_manager_uid=su1.user_id
		LEFT JOIN sys_department sysm ON sysm.dep_id = su1.dep_id
		LEFT JOIN sys_position sysp ON sysp.position_id=su1.position_id

		left join (SELECT
		GROUP_CONCAT(bc.business_circle_name) business_circle_multi,concat(',',GROUP_CONCAT(bc.business_circle_id),',') as business_circle_ids,rbc.residential_id
		FROM
		business_circle bc
		LEFT JOIN residential_business_circle rbc ON bc.business_circle_id = rbc.business_circle_id group by rbc.residential_id) bcm
		on bcm.residential_id=a.residential_id

		left join
		(SELECT
		GROUP_CONCAT(sd1.dep_name) residential_dept_response, concat(',',GROUP_CONCAT(DISTINCT(rd1.did)),',') dids,rd1.residential_id
		FROM
		residential_department rd1
		LEFT JOIN sys_department sd1 ON rd1.did = sd1.dep_id group by rd1.residential_id) rrd
		on
		rrd.residential_id = r.residential_id

		left JOIN online_house_info ohi ON ohi.apartment_id=a.apartment_id
		where a.deleted=0 and a.is_active = 'Y'
			    
		limit ${offset},${limit}

	</select>
	
	<select id="searchApartmentListCountByLog" parameterType="java.util.Map" resultType="java.lang.Integer">
		
			SELECT 
			    count(1)
			FROM
			    apartment a
			      
			        INNER JOIN
			    house_contract hc ON hc.house_id = a.house_id
			        AND hc.contract_id = a.house_contract_id
			        AND hc.is_active = 'Y'
			        AND hc.deleted = 0
			      
			WHERE
			    a.deleted = 0 AND a.is_active = 'Y'
				<if test="rent_status != null and '' != rent_status">
					and a.rent_status = #{rent_status}
				</if>
				<if test="rent_type != null and '' != rent_type">
					and a.rent_type = #{rent_type}
				</if>
				<if test="fire_status != null and '' != fire_status">
					and a.fire_status = #{fire_status}
				</if>
				<if test="category != null and '' != category">
					and a.category = #{category}
				</if>
				<if test="dealtype != null and '' != dealtype">
					and a.dealtype = #{dealtype}
				</if>
	</select>
	
	<insert id="insertApartmentCount" parameterType="com.isz.erp.facade.house.entity.ApartmentCount">
		INSERT INTO apartment_count(
		id,
		entire_rented,
		entire_booked,
		entire_warting_rent,
		entire_fired,
		entire_burnting,
		entire_invalid,
		entire_all_invalid,
		share_rented,
		share_booked,
		share_warting_rent,
		share_fired,
		share_burnting,
		share_invalid,
		share_all_invalid,
		create_time
		)
		VALUES(#{id},#{entire_rented},#{entire_booked}, #{entire_warting_rent}, #{entire_fired},
		#{entire_burnting}, #{entire_invalid},#{entire_all_invalid},
		#{share_rented},
		#{share_booked}, #{share_warting_rent}, #{share_fired},
		#{share_burnting},
		#{share_invalid}, #{share_all_invalid},#{create_time}
		)
    </insert>
    
    <select id="selectPreDayApartment" resultType="com.isz.erp.facade.house.entity.ApartmentCount">
    	select * from apartment_count order by create_time desc limit 1;
    </select>
    
    <insert id="insertApartmentCountRented" parameterType="com.isz.erp.facade.house.entity.ApartmentCountRented">
    	INSERT INTO apartment_count_rented(
			id,
			custom_inrent,
			custom_booked,
			custom_warting_rent,
			not_renew_but_can_see,
			not_renew_and_not_see,
			to_renew,
			rent_type,
			create_time
		)
		VALUES(#{id},#{custom_inrent},#{custom_booked}, #{custom_warting_rent}, #{not_renew_but_can_see},
			#{not_renew_and_not_see}, #{to_renew},
			#{rent_type},
			#{create_time}
		)
    </insert>
	
</mapper>
