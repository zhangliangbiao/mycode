<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.isz.erp.house.mapper.HouseExplorationMapper">
	<!-- resultMap -->
	<resultMap id="HouseExplorationMap" type="com.isz.erp.facade.house.entity.HouseExploration">
	    <id column="house_exploration_id" property="house_exploration_id"/>
	    <result column="residential_id" property="residential_id"/>
	    <result column="house_id" property="house_id"/>
	    <result column="fitment_type" property="fitment_type"/>
	    <result column="is_n" property="is_n"/>
	    <result column="intention_rent_price" property="intention_rent_price"/>
	    <result column="market_price" property="market_price"/>
	    <result column="plan_in_price" property="plan_in_price"/>
	    <result column="plan_configuration_price" property="plan_configuration_price"/>
	    <result column="plan_out_price" property="plan_out_price"/>
	    <result column="is_landord" property="is_landord"/>
	    <result column="is_provide_data" property="is_provide_data"/>
	    <result column="exploration_remark" property="exploration_remark"/>
	    <result column="is_first_exploration" property="is_first_exploration"/>
	    <result column="audit_uid" property="audit_uid"/>
	    <result column="audit_time" property="audit_time"/>
	    <result column="audit_status" property="audit_status"/>
	    <result column="audit_remark" property="audit_remark"/>
	    <result column="create_time" property="create_time"/>
	    <result column="create_uid" property="create_uid"/>
	    <result column="deleted" property="deleted"/>
	    <result column="update_time" property="update_time"/>
	    <result column="update_uid" property="update_uid"/>
	    <result column="user_name" property="user_name"/>
	    <result column="dep_name" property="dep_name"/>
	    <result column="exploration_user_name" property="exploration_user_name"/>
	    <result column="exploration_dep_name" property="exploration_dep_name"/>
	    <result column="property_name" property="property_name"/>
	    <result column="business_circle_name" property="business_circle_name"/>
	    <result column="area_name" property="area_name"/>
	    <result column="audit_user_name" property="audit_user_name"/>
	    <result column="audit_dep_name" property="audit_dep_name"/>
	    
	    <!-- 关联信息 -->
	    <!-- 意向产品 -->
	    <collection property="intentionProductList" column="house_exploration_id" select="com.isz.erp.house.mapper.HouseExplorationObjectMapper.selectIntentionListById" fetchType="eager">
	 	</collection>
	 	 <!-- 房东类型 -->
	    <collection property="landordTypeList" column="house_exploration_id" select="com.isz.erp.house.mapper.HouseExplorationObjectMapper.selectLandordListById" fetchType="eager">
	 	</collection>
	 	
 	</resultMap>
	<select id="searchHouseExplorationList" parameterType="java.util.Map" resultMap="HouseExplorationMap">
	
		SELECT 
			he.house_exploration_id,
			he.house_id,
			he.fitment_type,
			he.is_n,
			he.intention_rent_price,
			he.market_price,
			he.plan_in_price,
			he.plan_configuration_price,
			he.plan_out_price,
			he.is_landord,
			he.is_provide_data,
			he.exploration_remark,
			he.is_first_exploration,
			he.audit_uid,
			he.audit_time,
			he.audit_remark,
			he.audit_status,
			he.create_time,
			he.create_uid,
			he.deleted,
			su.user_name as exploration_user_name,
			sd.dep_name as exploration_dep_name, 
			h.property_name,
			bc.business_circle_name,
			sdt.name as area_name,
			su2.user_name as audit_user_name,
			sd2.dep_name as audit_dep_name
			
            FROM
		<include refid="searchHouseSQL"></include>
		
		<if test="null != offset and '' != offset and null != limit and '' != limit" > 
			limit offset,limit
		</if>
	</select>
	<!-- 符合查询条件的房屋记录总数 -->
	<select id="countSearchHouseExploration" parameterType="java.util.Map" resultType="java.lang.Integer">
		SELECT count(1)
				FROM
		<include refid="searchHouseSQL"></include>
	</select>
	
	<sql id="searchHouseSQL">
		house_exploration he 
		inner JOIN house h on(h.house_id=he.house_id)
		inner JOIN residential r on(h.residential_id=r.residential_id)
		inner JOIN residential_building rb on(rb.residential_id=r.residential_id and h.building_id=rb.building_id)
		LEFT JOIN residential_business_circle rbc on(h.residential_id=rbc.residential_id)
		LEFT JOIN business_circle bc on(bc.business_circle_id=rbc.business_circle_id)
		LEFT JOIN sys_district sdt on(sdt.code=h.area_code) 
		LEFT JOIN sys_user su ON su.user_id = he.create_uid
		LEFT JOIN sys_department sd ON sd.dep_id=su.dep_id
		LEFT JOIN sys_user su2 ON su2.user_id = he.audit_uid
		LEFT JOIN sys_department sd2 ON sd2.dep_id=su2.dep_id
		<include refid="houseListSql"></include>
		order by he.create_time desc
	</sql>
	
	
	<!-- 列表查询条件 -->
	<sql id="houseListSql">
		<where>
			<trim prefixOverrides="and">
				and he.deleted=0
				<if test="house_id != null and '' !=  house_id">
					 and he.house_id = #{house_id}
				</if>
				<if test="is_first_exploration != null and '' !=  is_first_exploration">
					 and he.is_first_exploration = #{is_first_exploration}
				</if>
				
				and h.deleted=0 
				<if test="null != city_code_search and '' != city_code_search">and h.house_id in(select house_id from house where city_code=#{city_code_search})</if>
				<if test="null != area_code_search and '' != area_code_search">and h.area_code in (${area_code_search})</if>
				<if test="null != business_circle_id_search and '' != business_circle_id_search">and rbc.business_circle_id in (${business_circle_id_search})</if>
				<!-- 申请部门 -->
				<if test="null != did_search and '' != did_search and (null == uid_search or '' == uid_search)">
					and EXISTS (select 1 from sys_department_flat t where t.child_id=su.dep_id and t.dept_id in (${did_search}))
				</if>
				<if test="null != uid_search and '' != uid_search">and he.create_uid in (${uid_search})</if>
				<if test="null != user_name_search and '' != user_name_search">and su.user_name like CONCAT('%','${user_name_search}','%' )</if>
				<if test="null != house_status_search and '' != house_status_search">and h.house_status in (${house_status_search})</if>
				<if test="null != audit_status_search and '' != audit_status_search">and he.audit_status in (${audit_status_search})</if>
				<if test="null != residential_name_search and '' != residential_name_search">and (r.residential_name like '%${residential_name_search}%')</if>
				<if test="null != create_time_start_search and '' != create_time_start_search"><![CDATA[and date(he.create_time) >= #{create_time_start_search}]]></if>
				<if test="null != create_time_end_search and '' != create_time_end_search"><![CDATA[and date(he.create_time) <= #{create_time_end_search}]]></if>
				<if test="null != audit_time_start_search and '' != audit_time_start_search"><![CDATA[and date(he.audit_time) >= #{audit_time_start_search}]]></if>
				<if test="null != audit_time_end_search and '' != audit_time_end_search"><![CDATA[and date(he.audit_time) <= #{audit_time_end_search}]]></if>
				<if test="null != audit_name_search and '' != audit_name_search"><![CDATA[and he.audit_uid in (${audit_name_search})]]></if>
				<if test="null != audit_context_search and '' != audit_context_search">and he.audit_remark like CONCAT('%','${audit_context_search}','%' )</if>
				<if test="null != building_name_search and '' != building_name_search">
					AND rb.building_name LIKE CONCAT('%',#{building_name_search},'%')
				</if>
				<if test="null != unit_search and '' != unit_search">
					AND h.unit LIKE CONCAT('%',#{unit_search},'%')
				</if>
				<if test="null != house_no_search and '' != house_no_search">
					AND h.house_no LIKE CONCAT('%',#{house_no_search},'%')
				</if>
				<if test="null != uid_name_search and '' != uid_name_search">
					AND su.user_name LIKE CONCAT('%',#{uid_name_search},'%')
				</if>
			</trim>
		</where>
		
	</sql>
	
	<update id="deleteHouseExploration" parameterType="String">
		UPDATE house_exploration set deleted=1 where house_exploration_id=#{house_exploration_id}
	</update>
	
	<select id="selectHouseExplorationHouseImgList" parameterType="String" resultType="com.isz.erp.facade.house.entity.HouseImg">
		SELECT h.residential_id,h.building_id,h.house_id,hei.img_id,hei.img_type,hei.img_sub_type 
		from house_exploration he ,house_exploration_img hei,house h 
		where he.house_exploration_id=#{house_exploration_id} 
		and hei.house_exploration_id=he.house_exploration_id and h.house_id=he.house_id
	</select>
	
	
	<update id="updateHouseRentExploration_uid" parameterType="com.isz.erp.facade.house.entity.HouseRent">
		UPDATE `house_rent`
		SET
			update_time=#{update_time},update_uid=#{update_uid},exploration_uid=#{exploration_uid},exploration_time=#{exploration_time}
		WHERE `house_id`=#{house_id}
	</update>
</mapper>