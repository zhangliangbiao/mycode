<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.isz.erp.house.mapper.HouseRoomImgMapper">
	<!-- 批量删除 -->
	<update id="deleteByHouseIdContractId" parameterType="java.lang.String">
		UPDATE house_room_img hri
		INNER JOIN house_room hr ON hr.room_id=hri.room_id
		INNER JOIN house h ON h.house_id=hr.house_id
		SET hri.`deleted`=1 
		WHERE h.house_id=#{house_id} AND hr.house_contract_id=#{contract_id}
	</update>
	<!-- 批量新增出租房间户型图(装修房屋公共区域的户型图) -->
	<insert id="saveHouseRoomImg" parameterType="java.util.List">
		INSERT INTO `house_room_img` 
			(`room_img_id`,`residential_id`, `building_id`, `house_id`, `img_id`, `room_id`, `img_name`, 
			`img_type`, `audit_status`, `audit_uid`, `deleted`, `sort`, `create_time`, `create_uid`, `fitment_room_id`)
		VALUES
        <foreach collection="list" item="item" index="index" separator="," >  
     	   (#{item.room_img_id},#{item.residential_id},#{item.building_id},#{item.house_id},#{item.img_id},#{item.room_id},#{item.img_name},
     	   #{item.img_type},#{item.audit_status},#{item.audit_uid},#{item.deleted},#{item.sort},#{item.create_time},#{item.create_uid},#{item.fitment_room_id})
   		</foreach>
	</insert>
	<!-- 出租房间图片列表 -->
	<select id="selectByRoomId" parameterType="java.lang.String" resultType="com.isz.erp.facade.house.entity.HouseRoomImg">
		SELECT hri.*,i.src,su.user_name as create_user,sd.dep_name as create_dep
		FROM house_room_img hri INNER JOIN image i ON hri.img_id=i.img_id
		INNER JOIN house_room hr ON hr.room_id=hri.room_id AND hr.fitment_room_id=hri.fitment_room_id
		LEFT JOIN sys_user su on hri.create_uid = su.user_id
		LEFT JOIN sys_department sd on sd.dep_id = su.dep_id
		WHERE hri.room_id=#{room_id} AND hri.deleted=0 ORDER BY IF(ISNULL(hri.sort),1,0),hri.sort ASC;
	</select>
	<!-- 出租房间公共区域图片列表 -->
	<select id="selectPublicByHouseId" parameterType="java.lang.String" resultType="com.isz.erp.facade.house.entity.HouseRoomImg">
		SELECT hri.*,i.src
		FROM house_room_img hri INNER JOIN image i ON hri.img_id=i.img_id
		INNER JOIN house_room hr ON hr.room_id=hri.room_id AND hr.fitment_room_id=hri.fitment_room_id
		WHERE hr.house_id=#{house_id} AND hr.public_flag='Y' AND hr.deleted=0 AND hri.deleted=0
		ORDER BY IF(ISNULL(hri.sort),1,0),hri.sort ASC;
	</select>
	<!-- 批量删除 -->
	<update id="deleteByFitmentId" parameterType="java.lang.String">
		UPDATE house_room_img hri 
		INNER JOIN house_room hr ON hr.fitment_room_id=hri.fitment_room_id
		INNER JOIN fitment_house fh ON fh.house_id=hr.house_id
		SET hri.`deleted`=1
		WHERE fh.fitment_id=#{fitment_id} AND hri.img_type='HOUSE_IMGS'
	</update>
	<!-- 同通过fitment_room_id删除 -->
	<update id="deleteByHouseIdAndRoomId" parameterType="java.util.Map">
		UPDATE house_room_img hri 
		INNER JOIN house_room hr ON hr.room_id=hri.room_id
		INNER JOIN house h ON h.house_id=hr.house_id
		SET hri.`deleted`=1 
		WHERE hri.room_id=#{room_id} AND h.house_id=#{house_id}
	</update>
	<!-- 插入房间图片 -->
	<insert id="insertHouseRoomImg" parameterType="com.isz.erp.facade.house.entity.HouseRoomImg">
		INSERT INTO `house_room_img` 
			(`room_img_id`,`residential_id`, `building_id`, `house_id`, `img_id`, `room_id`, `img_name`,
			`img_type`, `audit_status`, `audit_uid`, `deleted`, `sort`, `create_time`, `create_uid`,`fitment_room_id`)
		VALUES
			(#{room_img_id},#{residential_id},#{building_id},#{house_id},#{img_id},#{room_id},#{img_name},
			#{img_type},#{audit_status},#{audit_uid},#{deleted},#{sort},#{create_time},#{create_uid},#{fitment_room_id})
	</insert>
	<!-- 删除特定的出租房间图片［公共区域或卧室］ -->
	<update id="deleteByHouseIdAndRoomIdAndImgType" parameterType="java.util.Map">
		UPDATE house_room_img hri
		INNER JOIN house_room hr ON hr.room_id=hri.room_id
		INNER JOIN house h ON h.house_id=hr.house_id
		SET hri.`deleted`=1
		WHERE hri.room_id=#{room_id} AND h.house_id=#{house_id} AND hri.img_type=#{img_type}
	</update>
	<!-- -->
	<select id="selectPublicByHouseIdContractId" parameterType="java.util.Map" resultType="com.isz.erp.facade.house.entity.HouseRoomImg">
		SELECT hri.*,i.src,su.user_name as create_user,sd.dep_name as create_dep
		FROM house_room_img hri INNER JOIN image i ON hri.img_id=i.img_id
		INNER JOIN house_room hr ON hr.room_id=hri.room_id AND hr.fitment_room_id=hri.fitment_room_id
		LEFT JOIN sys_user su on hri.create_uid = su.user_id
		LEFT JOIN sys_department sd on sd.dep_id = su.dep_id
		WHERE hr.house_id=#{house_id} AND hr.public_flag='Y' AND hr.deleted=0 AND hri.deleted=0 AND hr.house_contract_id=#{house_contract_id}
		ORDER BY IF(ISNULL(hri.sort),1,0),hri.sort ASC;
	</select>

	<select id="selectByFitmentRoomId" parameterType="java.lang.String" resultType="com.isz.erp.facade.house.entity.HouseRoomImg">
		SELECT hri.*,i.src
		FROM house_room_img hri INNER JOIN image i ON hri.img_id=i.img_id
		WHERE hri.deleted=0 AND hri.fitment_room_id=#{fitment_room_id}
		ORDER BY hri.create_time ASC
	</select>

	<delete id="deleteByRoomIds" parameterType="java.util.Map">
		UPDATE house_room_img SET `deleted`=1
		WHERE img_type='HOUSE_IMGS' AND fitment_room_id IN (${roomIds})
	</delete>
	
	<update id="updateIndoorImgsFitmentRoomId" parameterType="java.util.Map">
		UPDATE house_room_img SET fitment_room_id=#{fitment_room_id} WHERE img_type='INDOOR_IMGS' AND room_id=#{room_id}
	</update>
	
   <!-- 出租房间图片列表 -->
	<select id="selectByHouseId" parameterType="java.lang.String" resultType="com.isz.erp.facade.house.entity.HouseRoomImg">
		SELECT hri.*,i.src,su.user_name as create_user,sd.dep_name as create_dep
		FROM house_room_img hri INNER JOIN image i ON hri.img_id=i.img_id
		INNER JOIN house_room hr ON hr.room_id=hri.room_id AND hr.fitment_room_id=hri.fitment_room_id
		LEFT JOIN sys_user su on hri.create_uid = su.user_id
		LEFT JOIN sys_department sd on sd.dep_id = su.dep_id
		WHERE hri.house_id=#{house_id} AND hri.deleted=0 ORDER BY IF(ISNULL(hri.sort),1,0),hri.sort ASC;
	</select>
</mapper>