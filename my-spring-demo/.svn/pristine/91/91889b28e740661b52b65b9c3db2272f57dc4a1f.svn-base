<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.isz.erp.house.mapper.FollowMapper">
	<!-- 房源跟进列表 -->
	<select id="searchFollowList" parameterType="java.util.Map" resultType="com.isz.erp.facade.house.entity.Follow">
		SELECT
			f.follow_id,
			f.object_type,
			f.object_id,
			f.follow_type,
			f.follow_content,
			f.follow_open,
			f.follow_date,
			f.deleted,
			f.create_time,
			f.create_uid,
			f.update_time,
			f.update_uid,
			su.user_name follow_user_name,
			sd.dep_name follow_dept_name
			
			<if test="'CUSTOMER' == object_type">
				,
				c.customer_num,
				c.customer_name,
				c.phone
			</if>
			<if test="'HOUSE' == object_type or 'APARTMENT' == object_type">
				,
				
				r.residential_name,
				CONCAT_WS('',rb.building_name,d.dict_value,CASE h.unit WHEN '无' THEN '' ELSE IFNULL(h.unit,'') END) building_unit,
				h.house_no
				<if test="'APARTMENT' == object_type">,a.category,a.house_id as house_id,a.apartment_type as apartment_type,a.rent_type as rent_type,a.rent_status as rent_status,a.apartment_code as code,hr_dict.dict_value as room_no</if>
				<if test="'HOUSE' == object_type">,h.house_id,h.house_code as code,hr.house_status,hr.category</if>
			</if>
		FROM
			follow AS f FORCE INDEX (idx_follow_update_time)
			LEFT JOIN sys_user su ON f.create_uid=su.user_id
			LEFT JOIN sys_department sd ON su.dep_id=sd.dep_id
		<include refid="listSql"></include>
		<if test="null != sort and sort != ''">
			ORDER BY ${sort}
			<if test="null != order and order != ''">
				${order}
			</if>
		</if>
	</select>
	<!-- 房源跟进记录总数 -->
	<select id="countSearchFollow" parameterType="java.util.Map" resultType="java.lang.Integer">
		SELECT
			COUNT(f.follow_id)
		FROM
			follow AS f FORCE INDEX (idx_follow_follow_type)
		INNER JOIN sys_user su ON f.create_uid=su.user_id
		INNER JOIN sys_department sd ON su.dep_id=sd.dep_id
		<include refid="listSql"></include>
	</select>
	<!-- 条件 -->
	<sql id="listSql">
		<if test="'CUSTOMER' == object_type">
			LEFT JOIN customer c ON f.object_id=c.customer_id  and c.deleted=0 
			<!-- LEFT JOIN sys_user suser ON suser.user_id = c.create_uid
			LEFT JOIN sys_department sde ON suser.dep_id=sde.dep_id -->
		</if>
		<if test="'HOUSE' == object_type">
	        LEFT JOIN house h ON f.object_id=h.house_id
			LEFT JOIN house_rent hr ON hr.house_id=h.house_id
			LEFT JOIN sys_user sub ON hr.belong_uid=sub.user_id
			LEFT JOIN sys_department sdb ON sub.dep_id=sdb.dep_id
			LEFT JOIN residential r ON r.residential_id=h.residential_id
			LEFT JOIN residential_building rb ON rb.building_id=h.building_id
			LEFT JOIN sys_dict_item d ON d.dict_code='Suffix' AND d.dict_key=rb.suffix
		</if>
		<if test="'APARTMENT' == object_type">
			INNER JOIN apartment a on a.apartment_id=f.object_id AND f.object_type=#{object_type} and a.deleted=0
			<if test="'APARTMENT' == object_type">
				<if test="null != code_search and '' != code_search">
					and a.apartment_code like CONCAT('%','${code_search}','%' )
				</if>
				<if test="null != rent_type and '' != rent_type">
					and a.rent_type = #{rent_type}
				</if>
				<if test="city_code_search != null and '' !=  city_code_search">
					and a.city_code = #{city_code_search}
				</if>
				<if test="null != area_code_search">and a.area_code in (${area_code_search})</if>
				<if test="null != category_search">and a.category in (${category_search})</if>
			</if>
	        LEFT JOIN house h ON a.house_id=h.house_id  and h.deleted=0
			LEFT JOIN residential r ON r.residential_id=h.residential_id
			LEFT JOIN residential_building rb ON rb.building_id=h.building_id
			LEFT JOIN sys_dict_item d ON d.dict_code='Suffix' AND d.dict_key=rb.suffix
			left join house_room hr on a.room_id = hr.room_id
			LEFT JOIN sys_dict_item hr_dict on hr_dict.dict_key = hr.room_no and hr_dict.dict_code = 'RoomNo'
			
		</if>
		<where>
			<trim prefixOverrides="and">
				and f.deleted=0 
					
				<if test="null != isShowSys and  '' != isShowSys ">
					<if test="isShowSys" >
						<![CDATA[and f.follow_type<>'SYSTEMEDIT' ]]>
					</if>
				</if>
				<if test="'CUSTOMER' == object_type">
					and  	(	 su.user_id = #{userId} 
					<if test="null != positionIds and '' != positionIds">
						or su.position_id in (${positionIds}) 
					</if>	
					)
					<if test="city_code_search != null and '' !=  city_code_search">
						and c.city_code = #{city_code_search}
					</if>
					<if test="null != area_code_search">and c.rent_area_code in (${area_code_search})</if>
					<!-- 数据权限
					<if test="null != permValue and '' != permValue">
						and
						(
							c.belong_uid  in (${permValue}) or f.create_uid in (${permValue})
							<if test="null != deptValue">
								or c.belong_did in (${deptValue}) or sd.dep_id in (${deptValue})
							</if>
						)
					</if>
					<if test="null == permValue and null != deptValue">
						and (c.belong_did in (${deptValue}) or sd.dep_id in (${deptValue}))
					</if> -->
					
				</if>
				<if test="'HOUSE' == object_type or 'APARTMENT' == object_type">
					and  	(	f.follow_open='Y' or su.user_id = #{userId} 
					<if test="null != positionIds and '' != positionIds">
						or su.position_id in (${positionIds}) 
					</if>	
					)
					<if test="city_code_search != null and '' !=  city_code_search">
						and h.city_code = #{city_code_search}
					</if>
					<if test="null != area_code_search">and h.area_code in (${area_code_search})</if>
					<if test="'HOUSE' == object_type">
						<if test="house_status_search != null and '' !=  house_status_search">
							and hr.house_status in (${house_status_search})
						</if>
						<if test="null != category_search">and hr.category in (${category_search})</if>
						<if test="null != code_search and '' != code_search">
							and h.house_code like CONCAT('%','${code_search}','%' )
						</if>
						<if test="null != belong_did_search and '' != belong_did_search and (null == belong_uid_search or '' == belong_uid_search)">
							AND EXISTS (
								SELECT 1 FROM sys_department_flat t WHERE
								t.child_id=sdb.dep_id AND t.dept_id IN (${belong_did_search})
							)
						</if>
						<if test="null != belong_uid_search and '' != belong_uid_search">
							and sub.user_id in (${belong_uid_search})
						</if>
						<!-- 数据权限[公开和系统跟进不受权限限制]
						<if test="null != permValue and '' != permValue">
							and
							(
								f.create_uid in (${permValue})
								<if test="null != deptValue">
									or sd.dep_id in (${deptValue})
								</if>
								or f.follow_open='Y' or f.follow_type='SYSTEMEDIT'
							)
						</if>
						<if test="null == permValue and null != deptValue">
							and (sd.dep_id in (${deptValue}) or f.follow_open='Y' or f.follow_type='SYSTEMEDIT')
						</if>
						<if test="(null == permValue or '' == permValue) and (null == deptValue or '' == deptValue)">
							and f.follow_open='Y'
						</if> -->
					</if>
					<if test="'APARTMENT' == object_type">
						<if test="null != category_search">and a.category in (${category_search})</if>
					</if>
					<if test="null != residential_name_search and '' != residential_name_search">
						and (
							r.residential_name like CONCAT('%','${residential_name_search}','%' )
							OR r.byname like CONCAT('%','${residential_name_search}','%' )
						)
					</if>
					<if test="null != building_name_search and '' != building_name_search">
						and rb.building_name like CONCAT('%','${building_name_search}','%' )
					</if>
					<if test="null != unit_search and '' != unit_search">
						and h.unit like CONCAT('%','${unit_search}','%' )
					</if>
					<if test="null != house_no_search and '' != house_no_search">
						and h.house_no like CONCAT('%','${house_no_search}','%' )
					</if>
				</if>
				<if test="null != follow_type_search and '' != follow_type_search">
					and f.follow_type in (${follow_type_search})
				</if>
				<if test="null != follow_uid_search and '' != follow_uid_search">
					and f.create_uid in (${follow_uid_search})
				</if>
				<if test="null != follow_did_search and '' != follow_did_search and (null == follow_uid_search or '' == follow_uid_search)">
					AND EXISTS (
						SELECT 1 FROM sys_department_flat t WHERE
						t.child_id=sd.dep_id AND t.dept_id IN (${follow_did_search})
					)
				</if>
				<if test="null != follow_date_start_search and '' != follow_date_start_search">
					<![CDATA[and f.follow_date >= CONCAT(#{follow_date_start_search},' 00:00:00')]]>
				</if>
				<if test="null != follow_date_end_search and '' != follow_date_end_search">
					<![CDATA[and f.follow_date <= CONCAT(#{follow_date_end_search},' 23:59:59' ) ]]>
				</if>
				<if test="null != customer_num_search and '' != customer_num_search">
					and c.customer_num like CONCAT('%','${customer_num_search}','%' )
				</if>
				<if test="null != customer_name_search and '' != customer_name_search">
					and c.customer_name like CONCAT('%','${customer_name_search}','%' )
				</if>
				<if test="null != phone_search and '' != phone_search">
					and c.phone like CONCAT('%','${phone_search}','%' )
				</if>
				<if test="null != object_type and '' != object_type">
					and f.object_type=#{object_type}
				</if>
				<if test="null != object_id and '' != object_id">
					and f.object_id=#{object_id}
				</if>
				<if test="null != follow_content_search and '' != follow_content_search">
					and f.follow_content like CONCAT('%','${follow_content_search}','%' )
				</if>
			</trim>
		</where>
	</sql>
	<!-- 删除跟进记录 -->
	<update id="deleteByObjectMap" parameterType="java.util.Map">
		UPDATE `follow`
		SET `deleted`=1, `update_time`=#{update_time}, `update_uid`=#{update_uid}
		WHERE `object_type`=#{object_type} AND `object_id`=#{object_id}
	</update>
	<!-- 获取最后一次跟进记录 -->
	<select id="getLastFollow" parameterType="java.util.Map" 
						resultType="com.isz.erp.facade.house.entity.Follow">
		SELECT follow_type,follow_content,follow_date from follow 
		where object_type=#{object_type}  and object_id=#{object_id} and deleted=0  ORDER BY follow_date desc LIMIT 1 
	</select>
	<!-- 获取最后一次跟进记录 -->
	<select id="getLastNotSysFollow" parameterType="java.util.Map" 
						resultType="com.isz.erp.facade.house.entity.Follow">
		SELECT follow_type,follow_content,follow_date from follow 
		where object_type=#{object_type}  and object_id=#{object_id} and deleted=0 <![CDATA[and follow_type<>'SYSTEMEDIT' ]]> ORDER BY follow_date desc LIMIT 1 
	</select>
	<!-- 获取该租客的所有跟进记录 -->
	<select id="countAllFollowByObjectId" parameterType="java.util.Map" resultType="java.lang.Integer">
		SELECT count(1) from follow where 
		object_type=#{object_type}  and object_id=#{object_id} and deleted=0  
	</select>
	
	<!-- 获取该房源24小时内非系统跟进记录数量 -->
	<select id="countLastFollowByObjectId" parameterType="java.util.Map" resultType="java.lang.Integer">
		SELECT
			COUNT(1)
		FROM
			follow
		WHERE
			object_type = 'HOUSE'
		AND follow_date >= DATE_ADD(now(), INTERVAL - 1 DAY)
		AND follow_type != 'SYSTEMEDIT'
		AND deleted=0
		AND object_id =#{object_id}
		AND create_uid=#{create_uid}
		AND follow_date >= (SELECT max(create_time) from house_roles_change_history WHERE house_id=#{object_id})
	</select>
	
</mapper>