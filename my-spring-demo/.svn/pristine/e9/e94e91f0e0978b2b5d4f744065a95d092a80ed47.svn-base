<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.isz.erp.house.mapper.ApartmentMapper">
	<!-- resultMap -->
	<resultMap id="ApartmentMap" type="com.isz.erp.facade.house.entity.Apartment">
	    <id column="apartment_id" property="apartment_id"/>
	    <result column="residential_id" property="residential_id"/>
	    <result column="building_id" property="building_id"/>
	    <result column="house_id" property="house_id"/>
	    <result column="house_contract_id" property="house_contract_id"/>
	    <result column="room_id" property="room_id"/>
	    <result column="city_code" property="city_code"/>
	    <result column="area_code" property="area_code"/>
	    <result column="apartment_code" property="apartment_code"/>
	    <result column="apartment_type" property="apartment_type"/>
	    <result column="rent_type" property="rent_type"/>
	    <result column="rent_status" property="rent_status"/>
	    <result column="look_type" property="look_type"/>
	    <result column="look_date" property="look_date"/>
	    <result column="fitment_cost" property="fitment_cost"/>
	    <result column="entrust_cost" property="entrust_cost"/>
	    <result column="capital_cost" property="capital_cost"/>
	    <result column="apartment_cost" property="apartment_cost"/>
	    <result column="rent_price" property="rent_price"/>
	    <result column="did" property="did"/>
	    <result column="uid" property="uid"/>
	    <result column="remark" property="remark"/>
	    <result column="is_active" property="is_active"/>
	    <result column="online_status" property="online_status"/>
	    <result column="online_uid" property="online_uid"/>
	    <result column="online_time" property="online_time"/>
	    <result column="activated_type" property="activated_type"/>
	    <result column="activated_time" property="activated_time"/>
	    <result column="activated_uid" property="activated_uid"/>
	    <result column="fire_status" property="fire_status"/>
	    <result column="deleted" property="deleted"/>
	    <result column="create_time" property="create_time"/>
	    <result column="create_uid" property="create_uid"/>
	    <result column="update_time" property="update_time"/>
	    <result column="update_uid" property="update_uid"/>
	    <result column="service_did" property="service_did"/>
	    <result column="service_uid" property="service_uid"/>

		<result column="tax_bear" property="tax_bear"/>

	    <result column="room_code" property="room_code"/>
	    <result column="room_no" property="room_no"/>
	    <result column="room_area" property="room_area"/>
	    <result column="room_orientation" property="room_orientation"/>
	    <result column="original_room_type" property="original_room_type"/>
	    <result column="decoration_style" property="decoration_style"/>
	    <result column="fitment_style" property="fitment_style"/>

		<result column="check_in_date" property="check_in_date"/>
		<result column="fitment_type" property="fitment_type"/>
		<result column="category" property="category"/>
		<result column="property" property="property"/>
		<result column="dealtype" property="dealtype"/>
		<result column="vacancy_date" property="vacancy_date"/>
		<result column="fire_days" property="fire_days"/>

	    <!-- 商圈 -->
	    <collection property="businessCircleList"
	    	column="residential_id" select="com.isz.erp.house.mapper.BusinessCircleMapper.selectBusidessCircleByResiId" fetchType="lazy">
	    </collection>

	    <!-- 托管公寓出租房源配置 -->
	    <collection property="houseConfigurationList" ofType="com.isz.erp.facade.house.entity.HouseConfiguration"
	 		column="house_id" select="com.isz.erp.house.mapper.HouseConfigurationMapper.selectByHouseId" fetchType="lazy">
	 	</collection>

	 	<!-- 托管房源出租房源图片 -->
	 	<collection property="houseImgList"
	 	    column="house_id" select="com.isz.erp.house.mapper.HouseImgMapper.selectListByHouseId" fetchType="lazy">
	 	</collection>

	 	<!-- 自营公寓房间特色信息列表 -->
		<collection property="houseRoomFeatureList" ofType="com.isz.erp.facade.house.entity.HouseRoomFeature"
	 		column="room_id" select="com.isz.erp.house.mapper.HouseRoomFeatureMapper.selectByRoomId" fetchType="lazy">
	 	</collection>

	 	<!-- 自营公寓房间配置信息列表 -->
		<collection property="houseRoomConfigurationList" ofType="com.isz.erp.facade.house.entity.HouseRoomConfiguration"
	 		column="room_id" select="com.isz.erp.house.mapper.HouseRoomConfigurationMapper.selectByRoomId" fetchType="lazy">
	 	</collection>

	 	<!-- 卧室房屋室内图 -->
	 	<collection property="houseRoomImgList"
	 	    column="room_id" select="com.isz.erp.house.mapper.HouseRoomImgMapper.selectByRoomId" fetchType="lazy">
	 	</collection>
	 	<collection  property="onlineHouseInfo" column="apartment_id" select="com.isz.erp.house.mapper.OnlineHouseInfoMapper.selectOnlineHouseInfoDetail" fetchType="lazy">
	 	</collection>
	 	
 	</resultMap>
 	
	<resultMap id="plusApartmentMap" type="com.isz.erp.facade.house.entity.Apartment" extends="ApartmentMap">
		
	    <result column="id" property="apartment_id"/>
	    <result column="fitment_status" property="fitment_status"/>
	    <result column="activate_type" property="activate_type"/>
	    <result column="residential_name" property="residential_name"/>
	    <result column="house_code" property="house_code"/>
	    <result column="apartment_follow_time" property="apartment_follow_time"/>
	    <result column="build_area" property="build_area"/>
	    <result column="sign_uid" property="sign_uid"/>
	    <result column="unit" property="unit"/>
	    <result column="house_no" property="house_no"/>
	    <result column="signUserName" property="signUserName"/>
	    <result column="signDeptName" property="signDeptName"/>
	    <result column="roomImgNumber" property="roomImgNumber"/>
	    <result column="serviceusername" property="serviceusername"/>
	    <result column="ground_floors" property="ground_floors"/>
	    <result column="building_name" property="building_name"/>
	    <result column="suffix" property="suffix"/>
	    <result column="floor" property="floor"/>
	    <result column="floor_floors" property="floor_floors"/>
	    <result column="rooms" property="rooms"/>
	    <result column="rent_end_date" property="rent_end_date"/>
	    <result column="area_name" property="area_name"/>
	    <result column="city_name" property="city_name"/>
	    <result column="livings" property="livings"/>
	    <result column="kitchens" property="kitchens"/>
	    <result column="bathrooms" property="bathrooms"/>
	    <result column="balconys" property="balconys"/>
	    <result column="reform_way" property="reform_way"/>
	    <result column="entrust_end_date" property="entrust_end_date"/>
	    <result column="orientation" property="orientation"/>
	    <result column="apartment_kind" property="apartment_kind"/>
	    <result column="fitment_style" property="fitment_style"/>
	    <result column="business_circle_multi" property="business_circle_multi"/>
	    <result column="house_room_feature_multi" property="house_room_feature_multi"/>
	    <result column="house_room_feature_ids" property="house_room_feature_ids"/>
	    <result column="residential_dept_response" property="residential_dept_response"/>
	    <result column="look_remark" property="look_remark"/>
	    <result column="delay_date" property="delay_date"/>
	    <result column="apartment_img_count" property="apartment_img_count"/>
	    <result column="house_role" property="house_role"/>
	    <result column="property_type" property="property_type"/>
	    <result column="property_use" property="property_use"/>
	    <result column="house_contract_create_time" property="house_contract_create_time"/>
	    <result column="byname" property="byname"/>
	    <result column="address" property="address"/>
	    <result column="sign_did" property="sign_did"/>
	    <result column="business_circle_ids" property="business_circle_ids"/>
	    <result column="dids" property="dids"/>
	    <result column="property" property="property"/>
	    <result column="web_manager_uid" property="web_manager_uid"/>
	    <result column="web_manager_uname" property="web_manager_uname"/>
	    <result column="web_manager_uphone" property="web_manager_uphone"/>
	    <result column="payment_cycle" property="payment_cycle"/>
	    <result column="customer_person_gender" property="customer_person_gender"/>
	    <result column="did_binary" property="did_binary"/>
	    <result column="pdid_binary" property="pdid_binary"/>	    
	    <result column="residential_building_name" property="residential_building_name"/>
	    <result column="issure_audit_status" property="issure_audit_status"/>
	    <result column="apartment_img_con_public_count" property="apartment_img_con_public_count"/>
		<result column="indoor_imgs" property="indoor_imgs"/>
		<result column="house_imgs" property="house_imgs"/>
		<result column="address" property="address"/> 

		<result column="lng" property="lng"/>
		<result column="lat" property="lat"/>
		<result column="geohashs" property="geohashs"/>

		<result column="web_manager_position_name" property="web_manager_position_name"/>
		<result column="web_manager_did" property="web_manager_did"/>
		<result column="web_manager_name" property="web_manager_name"/>
		<result column="customer_person_birth_date" property="customer_person_birth_date"/>
	</resultMap>
 	<resultMap id="onlineHouseInfoMapper" type="com.isz.erp.facade.house.entity.OnlineHouseInfo">
	    <id column="info_id" property="info_id"/>
	    <result column="house_id" property="house_id"/>
	    <result column="apartment_id" property="apartment_id"/>
	    <result column="house_id" property="house_id"/>
	    <result column="position_description" property="position_description"/>
	    <result column="door_model_describing" property="door_model_describing"/>
	    <result column="configuration_description" property="configuration_description"/>
	    <result column="agent_description" property="agent_description"/>
	    <result column="audit_status" property="audit_status"/>
	    <result column="create_time" property="create_time"/>
	    <result column="create_uid" property="create_uid"/>
	    <result column="update_time" property="update_time"/>
	     <result column="update_uid" property="update_uid"/>
	    
	       <!-- 首页推荐 -->
	    <collection property="categoryList"
	    	column="info_id" select="com.isz.erp.house.mapper.OnlineHouseCategoryMapper.selectCategoryDetailListByInfoId" fetchType="eager">
	    </collection>
	    
	    <!-- 推荐标签 -->
	     <collection property="onlineHouseTagList"
	    	column="info_id" select="com.isz.erp.house.mapper.OnlineHouseTagsMapper.selectTagDetailListByInfoId" fetchType="eager">
	    </collection>
	    </resultMap>

	<select id="selectCurrentApartmentRentPrice" parameterType="string" resultType="map">
		select * from apartment_contract_rent_info where contract_id=#{0} and start_date <![CDATA[<=]]> now() and end_date <![CDATA[>=]]> now() order by start_date asc limit 1
	</select>

	<select id="selectCustomerPersonById" resultType="map">
		select * from customer_person where person_id=#{0}
	</select>



	<sql id="sqlForList">
        <where>
			<trim prefixOverrides="and">
				and a.is_active='Y' 
				<if test="apartment_code_search != null  and apartment_code_search != ''">
					and a.apartment_code like CONCAT('%','${apartment_code_search}','%')
				</if>
				<if test="city_code_search != null and '' != city_code_search">
					and a.city_code = #{city_code_search}
				</if>
				<if test="area_code_search != null">
					and a.area_code in (${area_code_search})
				</if>
				 <if test="residential_name_search != null and '' != residential_name_search">
					and (
					 	r.residential_name like CONCAT('%','${residential_name_search}','%')
					 	OR r.byname like CONCAT('%','${residential_name_search}','%' )
					 )
				</if>
				<if test="residential_name_house_code_search != null and '' != residential_name_house_code_search">
					and (r.residential_name like CONCAT('%','${residential_name_house_code_search}','%')
					OR a.apartment_code like CONCAT('%','${residential_name_house_code_search}','%')
					OR r.byname like CONCAT('%','${residential_name_house_code_search}','%' )
					)
				</if>
				 <if test="building_name_search != null and '' != building_name_search">
					and rb.building_name like CONCAT('%','${building_name_search}','%')
				</if>
				 <if test="unit_search != null and '' != unit_search">
					and h.unit = #{unit_search}
				</if>
				<if test="house_no_search != null and '' != house_no_search">
					and h.house_no like CONCAT('%','${house_no_search}','%' )
				</if>
				<if test="activated_type_search != null and '' !=activated_type_search">
					and a.activated_type in (${activated_type_search})
				</if>
				<if test="rooms_search != null and '' != rooms_search">
					and fh.rooms in (${rooms_search})
				</if>
				<if test="fitment_type_search != null and '' != fitment_type_search">
					and a.fitment_type in (${fitment_type_search})
				</if>
				 <if test="rent_status_search != null and '' != rent_status_search">
					and a.rent_status in (${rent_status_search})
				</if>
				<if test="build_area_min_search != null and '' != build_area_min_search">
					and h.build_area <![CDATA[>=]]> #{build_area_min_search}
				</if>
				<if test="build_area_max_search != null and '' != build_area_max_search">
					and h.build_area <![CDATA[<=]]> #{build_area_max_search}
				</if>
				<if test="floor_min_search != null">
					and h.floor <![CDATA[>=]]> ${floor_min_search}
				</if>
				<if test="floor_max_search != null">
					and h.floor <![CDATA[<=]]> ${floor_max_search}
				</if>
				<if test="rent_price_min_search != null">
					and a.rent_price <![CDATA[>=]]> #{rent_price_min_search}
				</if>
				<if test="rent_price_max_search != null">
					and a.rent_price <![CDATA[<=]]> #{rent_price_max_search}
				</if>
				<if test="look_date_min_search != null">
					and date(a.look_date) <![CDATA[>=]]> #{look_date_min_search}
				</if>
				<if test="look_date_max_search != null">
					and date(a.look_date) <![CDATA[<=]]> #{look_date_max_search}
				</if>
				<if test="activated_time_min_search != null">
					and date(a.activated_time) <![CDATA[>=]]> #{activated_time_min_search}
				</if>
				<if test="activated_time_max_search != null">
					and date(a.activated_time) <![CDATA[<=]]> #{activated_time_max_search}
				</if>
				<!-- 签约部门 -->
				<if test="sign_dept_search != null and '' != sign_dept_search and (null == sign_uid_search or '' == sign_uid_search)">
					and su.dep_id in (select t.child_id from sys_department_flat t where t.dept_id in (${sign_dept_search}))
				</if>
				<!-- 签约人 -->
				<if test="sign_uid_search != null and '' != sign_uid_search">
					and hc.sign_uid in (${sign_uid_search})
				</if>
				<!-- 所属部门 -->
				<if test="belong_dept_search != null and '' != belong_dept_search and (null == belong_uid_search or '' == belong_uid_search)">
					and asu.dep_id in (select t.child_id from sys_department_flat t where t.dept_id in (${belong_dept_search}))
				</if>
				<!-- 所属人 -->
				<if test="belong_uid_search != null">
					and a.uid in (${belong_uid_search})
				</if>
				<if test="business_circle_search != null">
					and EXISTS(select 1 from residential_business_circle c where c.residential_id=a.residential_id and c.business_circle_id in (${business_circle_search}))
				</if>
				<if test="feature_code_search != null">
					and EXISTS(select 1 from house_room_feature cf where cf.room_id=hr.room_id and cf.feature_code in (${feature_code_search}))
				</if>
				<if test="orientation_search != null">
					and h.orientation in (${orientation_search})
				</if>
				<if test="rent_end_date_min_search != null">
					and date(ac.rent_end_date) <![CDATA[>=]]> #{rent_end_date_min_search}
				</if>
				<if test="rent_end_date_max_search != null">
					and date(ac.rent_end_date) <![CDATA[<=]]> #{rent_end_date_max_search}
				</if>
				<if test="property_use_search != null">
					and h.property_use in (${property_use_search})
				</if>
				<if test="property_type_search != null">
					and h.property_type in (${property_type_search})
				</if>
				<if test="apartment_follow_time_min_search != null">
					and date(arf.apartment_follow_time) <![CDATA[>=]]> #{apartment_follow_time_min_search}
				</if>
				<if test="apartment_follow_time_max_search != null">
					and date(arf.apartment_follow_time) <![CDATA[<=]]> #{apartment_follow_time_max_search}
				</if>
				<if test="fire_status_search != null">
					and a.fire_status in (${fire_status_search})
				</if>

				 <!-- 责任部门 -->
				<if test="dept_response_search != null">
					and EXISTS(select 1 from residential_department d where d.residential_id=r.residential_id and d.did in (${dept_response_search}))
				</if>
				<!-- 服务管家 -->
				<if test="service_uid_search != null">
					and a.service_uid in (${service_uid_search})
				</if>
				<if test="apartment_type_search != null">
					and a.apartment_type in (${apartment_type_search})
				</if>
				<if test="fitment_status_search != null">
					and fh.fitment_status in (${fitment_status_search})
				</if>
				<!-- 是否有钥匙 -->
				<if test="apartment_key_search != null and apartment_key_search == 0">
					and (a.look_type != 'HAVE_KEY' and a.look_type != 'SMART_KEY' OR a.look_type IS NULL)
				</if>
				<if test="apartment_key_search != null and apartment_key_search == 1">
					and (a.look_type = 'HAVE_KEY' or a.look_type = 'SMART_KEY')
				</if>

				<!-- 托管日期 -->
				<if test="house_contract_create_time_min_search != null">
					and date(hc.create_time) <![CDATA[>=]]> #{house_contract_create_time_min_search}
				</if>
				<if test="house_contract_create_time_max_search != null">
					and date(hc.create_time) <![CDATA[<=]]> #{house_contract_create_time_max_search}
				</if>
				<if test="reform_way_search != null">
					and fh.reform_way in (${reform_way_search})
				</if>
				<if test="look_type_search != null">
					and a.look_type in (${look_type_search})
				</if>
				<if test="apartment_kind_search != null">
					and fh.apartment_kind in (${apartment_kind_search})
				</if>
				<if test="entrust_end_date_min_search != null">
					and date(hc.entrust_end_date) <![CDATA[>=]]> #{entrust_end_date_min_search}
				</if>
				<if test="entrust_end_date_max_search != null">
					and date(hc.entrust_end_date) <![CDATA[<=]]> #{entrust_end_date_max_search}
				</if>
			</trim>
			and a.deleted = 0
			and a.is_active = 'Y'
			and a.rent_type = #{rent_type_search}
			and hc.deleted = 0
        </where>
	</sql>

	<!-- 符合查询 条件的整租房源信息 -->
	<select id="searchApartmentList" parameterType="java.util.Map" resultMap="ApartmentMap">

		select

		<include refid="colEntireApartmentSQL"/>

		<include refid="entireApartmentSql"></include>

		<include refid="condEntireApartmentSql"/>

		<if test="null != sort and sort != ''">
			ORDER BY ${sort}
			<if test="null != order and order != ''">
				${order}
			</if>
		</if>
		<if test="null != offset and '' != offset and null != limit and '' != limit" >
			limit offset,limit
		</if>

	</select>

	<!-- 符合查询条件的整租房源记录总数 -->
	<select id="countSearchApartment" parameterType="java.util.Map" resultType="java.lang.Integer">
		SELECT count(1) <include refid="entireApartmentSql"></include>  <include refid="condEntireApartmentSql"/>
	</select>

	<sql id="colEntireApartmentSQL">
		a.house_contract_id,
		a.room_id,
		hr.room_code,

		a.apartment_id,
		a.residential_id,
		a.building_id,
		a.house_id,
		a.room_id,
		a.apartment_code,
		a.apartment_type,
		a.rent_type,
		a.rent_status,
		a.property,
		a.category,
		a.dealtype,
		a.fire_status,
		fh.fitment_status,
		fh.fitment_style,
		a.look_date,
		a.look_type,
		a.city_code,
		a.area_code,
		a.online_status,
		a.online_time,
		a.online_uid,
		a.activated_time,
		a.activated_type,
		a.activated_uid,
		a.fitment_cost,
		a.entrust_cost,
		a.capital_cost,
		a.apartment_cost,
		a.rent_price,
		asu.dep_id as did,
		a.uid,
		a.remark,
		a.create_time,
		a.create_uid,
		a.deleted,
		r.residential_name,
		sd.`name` AS area_name,
		h.house_code,
		hr.room_no,
		case a.rent_type when 'ENTIRE' then
			h.orientation
		ELSE
			hr.room_orientation
		END orientation,
		case a.rent_type when 'ENTIRE' then
			h.build_area
		ELSE
			hr.room_area
		END build_area,
		a.fitment_type,
		hc.sign_uid,
		su.dep_id as sign_did,
		hc.delay_date,
		su.user_name AS signUserName,
		a.look_remark,
		sysd.dep_name AS signDeptName,
		case a.rent_type when 'ENTIRE' then
		(CASE
		WHEN
		a.apartment_type = 'MANAGE'
		THEN
		(SELECT
		COUNT(house_img_id) apartment_img_count
		FROM
		house_img hi
		WHERE
		hi.house_id = h.house_id
		AND hi.deleted = 0)
		ELSE (SELECT
		COUNT(room_img_id) apartment_img_count
		FROM
		house_room_img hri
		WHERE
		hri.house_id = a.house_id
		AND hri.deleted = 0)
		END)
		 else
		 (
		 SELECT
			COUNT(room_img_id)
			FROM
			house_room_img hri
			WHERE
			hri.room_id = a.room_id
			AND hri.deleted = 0
		  )
		end apartment_img_count,
		(SELECT
		MAX(follow_date) AS apartment_follow_time
		FROM
		follow
		WHERE
		object_type = 'APARTMENT'
		and deleted=0
		and object_id = a.apartment_id) as apartment_follow_time,
		rb.ground_floors,
		rb.building_name,
		rb.suffix,
		rb.house_role,
		h.unit,
		h.house_no,
		h.floor,
		CONCAT(h.floor, '|', rb.underground_floors + rb.ground_floors) AS floor_floors,
		h.property_type,
		h.property_use,
		(SELECT
		MAX(ac.rent_end_date) AS rent_end_date
		FROM
		apartment_contract ac
		LEFT JOIN
		apartment_contract_relation acr ON acr.contract_id = ac.contract_id

		WHERE
		ac.deleted = 0 
		AND (ac.contract_status = 'EFFECTIVE'
		OR ac.contract_status = 'CONTINUED')
		and acr.apartment_id = a.apartment_id
		) as rent_end_date,

		hc.entrust_end_date,
		hc.create_time AS house_contract_create_time,
		CASE a.apartment_type
		WHEN 'MANAGE' THEN 'UNRRESTYLE'
		WHEN 'BRAND' THEN fh.reform_way
		ELSE ''
		END reform_way,
		CASE a.apartment_type
		WHEN 'MANAGE' THEN 'MANAGE'
		WHEN 'BRAND' THEN fh.apartment_kind
		ELSE ''
		END apartment_kind,
		CASE a.apartment_type
		WHEN 'MANAGE' THEN h.rooms
		WHEN 'BRAND' THEN fh.rooms
		ELSE '0'
		END rooms,
		CASE a.apartment_type
		WHEN 'MANAGE' THEN h.livings
		WHEN 'BRAND' THEN fh.livings
		ELSE '0'
		END livings,
		CASE a.apartment_type
		WHEN 'MANAGE' THEN h.kitchens
		WHEN 'BRAND' THEN fh.kitchens
		ELSE '0'
		END kitchens,
		CASE a.apartment_type
		WHEN 'MANAGE' THEN h.bathrooms
		WHEN 'BRAND' THEN fh.bathrooms
		ELSE '0'
		END bathrooms,
		CASE a.apartment_type
		WHEN 'MANAGE' THEN h.balconys
		WHEN 'BRAND' THEN fh.balconys
		ELSE '0'
		END balconys,
		serviceu.user_name AS serviceusername,
		a.service_uid,
		a.service_did,
		(SELECT
		d.name
		FROM
		sys_district d
		WHERE
		d.code = a.city_code) AS city_name,
		(SELECT
		GROUP_CONCAT(bc.business_circle_name)
		FROM
		business_circle bc
		LEFT JOIN residential_business_circle rbc ON bc.business_circle_id = rbc.business_circle_id
		WHERE
		rbc.residential_id = a.residential_id) business_circle_multi,
		(SELECT
		GROUP_CONCAT(DISTINCT(sdi.dict_value))
		FROM
		sys_dict_item sdi
		INNER JOIN
		house_room_feature hrf ON hrf.feature_code = sdi.dict_e_value
		AND sdi.is_active = '1'
		WHERE
		hrf.room_id = a.room_id) house_room_feature_multi,
		(SELECT
		GROUP_CONCAT(DISTINCT(sdi.dict_e_value))
		FROM
		sys_dict_item sdi
		INNER JOIN
		house_room_feature hrf ON hrf.feature_code = sdi.dict_e_value
		AND sdi.is_active = '1'
		WHERE
		hrf.room_id = a.room_id) house_room_feature_ids,
		(SELECT
		GROUP_CONCAT(sd1.dep_name)
		FROM
		sys_department sd1
		LEFT JOIN residential_department rd1 ON rd1.did = sd1.dep_id
		WHERE
		rd1.residential_id = r.residential_id) residential_dept_response

	</sql>

	<sql id="entireApartmentSql">

		FROM
		apartment a
		inner join sys_user asu on asu.user_id=a.uid
		JOIN residential r ON a.residential_id = r.residential_id
		JOIN residential_building rb ON a.building_id = rb.building_id
		JOIN house h ON a.house_id = h.house_id
		LEFT JOIN sys_district sd ON a.area_code = sd.code
		LEFT JOIN sys_district sd_city ON a.city_code = sd_city.code
		left JOIN house_room hr ON a.room_id = hr.room_id AND hr.deleted = 0 AND hr.is_active = 'Y'
		INNER JOIN house_contract hc ON hc.house_id = h.house_id
		AND hc.contract_id = a.house_contract_id
		AND hc.is_active = 'Y'
		AND hc.deleted = 0
		LEFT JOIN sys_user su ON hc.sign_uid = su.user_id
		<!-- LEFT JOIN sys_department sysd ON hc.sign_did = sysd.dep_id -->
		LEFT JOIN sys_department sysd ON su.dep_id = sysd.dep_id
		LEFT JOIN sys_user serviceu ON serviceu.user_id = a.service_uid
		LEFT JOIN fitment_house fh ON fh.house_id = h.house_id
		AND fh.contract_id = a.house_contract_id

		<include refid="sqlForList"></include>

	</sql>

	<sql id="condEntireApartmentSql">
		<where>
			<trim prefixOverrides="and">
				<if test="apartment_img_count_search != null and apartment_img_count_search == 0">
					and apartment_img_count = 0
				</if>
				<if test="apartment_img_count_search != null and apartment_img_count_search == 1">
					and <![CDATA[apartment_img_count >= 1 and apartment_img_count <= 4]]>
				</if>
				<if test="apartment_img_count_search != null and apartment_img_count_search == 2">
					and <![CDATA[apartment_img_count >= 5]]>
				</if>
			</trim>
		</where>
	</sql>

	<!-- 根据自营公寓ID返回整租房源信息 -->
	<select id="selectEntireHouseByApartmentId" parameterType="java.lang.String" resultMap="ApartmentMap">
		SELECT DISTINCT
			a.apartment_id, a.residential_id,a.building_id,a.house_contract_id,a.house_id,a.room_id,a.apartment_code,a.apartment_type,a.rent_type,a.rent_status,a.property,a.category,a.dealtype,a.fire_status,
	        fh.fitment_status,a.look_date,a.look_type,a.city_code,a.area_code,a.online_status,a.online_time,a.online_uid,a.activated_time,a.activated_type,a.look_remark,a.cost_account,
	        a.activated_uid, a.fitment_cost,a.entrust_cost,a.capital_cost,ROUND((a.fitment_cost+a.entrust_cost+a.capital_cost),2) apartment_cost,a.rent_price,asu.dep_id as did,a.uid,a.remark,a.create_time,a.create_uid,a.update_time,a.update_uid,a.deleted,a.check_in_date,a.vacancy_date,
	        sd.`name` as area_name,h.house_code,h.build_area,a.fitment_type,hc.sign_uid, su.dep_id as sign_did,su.user_name as signUserName,
	        sysd.dep_name as signDeptName, h.property_name as address,r.address as house_property_address,(SELECT count(house_img_id) FROM house_img hi where hi.house_id=h.house_id) as apartment_count,r.residential_name,
			rb.ground_floors,rb.building_name,rb.suffix,rb.house_role, h.unit, h.house_no, CONCAT(h.floor,"|",rb.underground_floors+rb.ground_floors) as floor_floors,hroom.room_no,h.property_name as house_address,
			CASE a.apartment_type
			WHEN 'MANAGE' THEN 'UNRRESTYLE'
			WHEN 'BRAND' THEN fh.reform_way
			ELSE ''
			END reform_way,
			CASE a.apartment_type
			WHEN 'MANAGE' THEN 'MANAGE'
			WHEN 'BRAND' THEN fh.apartment_kind
			ELSE ''
			END apartment_kind,
			CASE a.apartment_type
			WHEN 'MANAGE' THEN h.rooms
	            WHEN 'BRAND' THEN fh.rooms
	            ELSE '0'
			END rooms,
			CASE a.apartment_type
			WHEN 'MANAGE' THEN h.livings
	            WHEN 'BRAND' THEN fh.livings
	            ELSE '0'
			END livings,
			CASE a.apartment_type
			WHEN 'MANAGE' THEN h.kitchens
	            WHEN 'BRAND' THEN fh.kitchens
	            ELSE '0'
			END kitchens,
			CASE a.apartment_type
			WHEN 'MANAGE' THEN h.bathrooms
	            WHEN 'BRAND' THEN fh.bathrooms
	            ELSE '0'
			END bathrooms,
			CASE a.apartment_type
			WHEN 'MANAGE' THEN h.balconys
	            WHEN 'BRAND' THEN fh.balconys
	            ELSE '0'
			END balconys,
			h.property_use,h.property_type,h.orientation,hr.now_status,
			(select d.name from sys_district d where d.code=a.city_code) as city_name,serviceu.user_name as serviceusername,a.service_uid,serviceu.dep_id service_did,
			(SELECT GROUP_CONCAT(sd1.dep_name) FROM sys_department sd1 
		          LEFT JOIN residential_department rd1 on rd1.did=sd1.dep_id
		          WHERE rd1.residential_id=r.residential_id
			) residential_dept_response,
			a.web_manager_uid,
			web.dep_id as web_manager_did
		FROM apartment a
		inner join sys_user asu on a.uid=asu.user_id
		LEFT JOIN residential r ON a.residential_id=r.residential_id
		LEFT JOIN residential_building rb ON a.building_id=rb.building_id 
		LEFT JOIN house h ON a.house_id=h.house_id
		LEFT JOIN house_rent hr ON h.house_id = hr.house_id
		LEFT JOIN house_room hroom ON a.room_id = hroom.room_id
		LEFT JOIN sys_district sd ON a.area_code=sd.code
		INNER JOIN house_contract hc ON hc.house_id=h.house_id AND hc.contract_id = a.house_contract_id
		LEFT JOIN sys_user su ON hc.sign_uid=su.user_id
		LEFT JOIN sys_user web ON a.web_manager_uid = web.user_id
		<!-- LEFT JOIN sys_department sysd ON hc.sign_did=sysd.dep_id -->
		left join sys_department sysd on su.dep_id=sysd.dep_id
		LEFT JOIN sys_user serviceu ON serviceu.user_id=a.service_uid
		<!-- 考虑托管房的情况 -->
		LEFT JOIN fitment_house fh ON fh.house_id=h.house_id AND fh.contract_id=a.house_contract_id
		WHERE a.deleted = 0 and a.apartment_id = #{apartment_id}
	</select>

	<!-- 根据自营公寓ID返回合租房源信息 -->
	<select id="selectShareHouseByApartmentId" parameterType="java.lang.String" resultMap="ApartmentMap">
		SELECT 
			a.apartment_id, a.residential_id,a.building_id,a.house_contract_id,a.house_id,a.room_id,a.apartment_code,a.apartment_type,a.rent_type,a.rent_status,a.property,a.category,a.dealtype,a.fire_status,a.apartment_cost,
	        a.look_date,a.look_type,a.city_code,a.area_code,a.online_status,a.online_time,a.online_uid,a.activated_time,a.activated_type,
	        a.activated_uid, a.fitment_cost,a.entrust_cost,a.capital_cost,a.apartment_cost,a.rent_price,su.dep_id as did,a.uid,a.remark,a.create_time,a.create_uid,a.deleted,a.update_time,a.update_uid,a.check_in_date,a.vacancy_date,
	        r.residential_name,a.look_remark,a.cost_account,
	        fh.fitment_status,fh.apartment_kind,fh.fitment_style,h.property_name as address,r.address as house_property_address,
			h.house_code,h.build_area,h.property_name as house_address,a.fitment_type,hc.sign_uid, su.dep_id as sign_did,hc.delay_date,su.user_name as belongUserName, sysd.dep_name as belongDeptName,  h.property_name as address,
			(SELECT count(house_img_id) FROM house_img hi where hi.house_id=h.house_id) as apartment_count,

			(SELECT
				MAX(follow_date) AS apartment_follow_time
			FROM
				follow
			WHERE
				object_type = 'APARTMENT'
				and a.apartment_id = follow.object_id
			) as apartment_follow_time,r.address,sd.`name` as area_name,sd_city.`name` as city_name,
			rb.ground_floors,rb.building_name,rb.suffix,rb.house_role, h.unit, h.house_no, CONCAT(h.floor,"|",rb.underground_floors+rb.ground_floors) as floor_floors, fh.rooms, h.property_use,h.property_type,
			fh.livings,fh.kitchens, fh.bathrooms, fh.balconys,hc.reform_way,a.service_uid,serviceu.dep_id service_did,
			hr.room_code,hr.room_no,hr.room_area,hr.room_orientation,hr.original_room_type,hr.decoration_style,
			(SELECT GROUP_CONCAT(sd1.dep_name) FROM sys_department sd1 
		          LEFT JOIN residential_department rd1 on rd1.did=sd1.dep_id
		          WHERE rd1.residential_id=r.residential_id
			) residential_dept_response,
			web_manager_uid,
			web.dep_id as web_manager_did
		FROM apartment a
		
		LEFT JOIN residential r ON a.residential_id=r.residential_id
		LEFT JOIN residential_building rb ON a.building_id=rb.building_id
		LEFT JOIN house h ON a.house_id=h.house_id
		LEFT JOIN house_room hr ON a.room_id=hr.room_id
		LEFT JOIN sys_district sd ON a.area_code=sd.code
		LEFT JOIN sys_district sd_city ON a.city_code=sd_city.code
		INNER JOIN house_contract hc ON hc.house_id=h.house_id AND hc.contract_id = a.house_contract_id
		LEFT JOIN fitment_house fh ON fh.house_id=h.house_id AND fh.contract_id=hc.contract_id
		LEFT JOIN sys_user su ON hc.sign_uid=su.user_id
		LEFT JOIN sys_user web ON a.web_manager_uid=web.user_id
		<!-- LEFT JOIN sys_department sysd ON a.did=sysd.dep_id -->
		left join sys_department sysd on su.dep_id=sysd.dep_id
		LEFT JOIN sys_user serviceu ON serviceu.user_id=a.service_uid
		
		WHERE a.apartment_id = #{apartment_id} AND hr.public_flag='N'
	</select>

	<!-- 更新公寓信息 -->
	<update id="updateApartmentById" parameterType="com.isz.erp.facade.house.entity.Apartment">
		UPDATE `apartment`
		SET
		 `update_time` = now()
  		 ,`update_uid` = #{update_uid}
  		 <if test="city_code != null and city_code != ''">
  		 	,city_code = #{city_code}
  		 </if>
  		 <if test="area_code != null and area_code != ''">
  		 	,area_code = #{area_code}
  		 </if>
		 <if test="apartment_code != null and apartment_code != ''">
  		 	,apartment_code = #{apartment_code}
  		 </if>
		 <if test="apartment_type != null and apartment_type != ''">
  		 	,apartment_type = #{apartment_type}
  		 </if>
		 <if test="rent_type != null and rent_type != ''">
  		 	,rent_type = #{rent_type}
  		 </if>
		 <if test="rent_status != null and rent_status != ''">
  		 	,rent_status = #{rent_status}
  		 </if>
		 <if test="look_type != null and look_type != ''">
  		 	,look_type = #{look_type}
  		 </if>
  		 	,look_date = #{look_date}
		 <if test="fitment_cost != null">
  		 	,fitment_cost = #{fitment_cost}
  		 </if>
		 <if test="entrust_cost != null">
  		 	,entrust_cost = #{entrust_cost}
  		 </if>
		 <if test="rent_price != null">
  		 	,rent_price = #{rent_price}
  		 </if>
		 <if test="did != null">
  		 	,did = #{did}
  		 </if>
		 <if test="uid != null">
  		 	,uid = #{uid}
  		 </if>
		 <if test="remark != null and remark != ''">
  		 	,remark = #{remark}
  		 </if>
		 <if test="is_active != null and is_active != ''">
  		 	,is_active = #{is_active}
  		 </if>
		 <if test="online_status != null and online_status != ''">
  		 	,online_status = #{online_status}
  		 </if>
		 <if test="online_uid != null">
  		 	,online_uid = #{online_uid}
  		 </if>
		 <if test="online_time != null and online_time != ''">
  		 	,online_time = #{online_time}
  		 </if>
  		 	,activated_type = #{activated_type}
		 <if test="activated_time != null and activated_time != ''">
  		 	,activated_time = #{activated_time}
  		 </if>
		 <if test="activated_uid != null">
  		 	,activated_uid = #{activated_uid}
  		 </if>
  		 <if test="fire_status != null and fire_status != ''">
  		 	,fire_status = #{fire_status}
  		 </if>
  		 <if test="service_uid != null">
  		 	,service_uid = #{service_uid}
  		 </if>
		 <if test="service_did != null">
  		 	,service_did = #{service_did}
  		 </if>
  		 <if test="can_check_in_date != null">
  		 	,check_in_date = #{can_check_in_date}
  		 </if>
  		 <if test="look_remark != null">
  		 	,look_remark = #{look_remark}
  		 </if>
  		 <if test="web_manager_uid != null">
  		 	,web_manager_uid = #{web_manager_uid}
  		 </if>

		WHERE `apartment_id`=#{apartment_id}
	</update>

	<!-- 判断公寓是否有出租合同记录 -->
	<select id="countApartmentContract" parameterType="java.lang.String" resultType="java.lang.Integer">
		SELECT COUNT(0) FROM apartment a 
		INNER JOIN apartment_contract_relation acr ON a.apartment_id=acr.apartment_id
		WHERE a.apartment_id=#{apartment_id} 
	</select>

	<!-- 查询是否有自营公寓出租合同应收租金数据 -->
	<select id="searchApartmentContractReceivable" parameterType="java.lang.String" resultType="java.lang.Integer">
		SELECT 1 FROM apartment_contract_receivable cr 
		INNER JOIN apartment_contract ac ON ac.contract_id=cr.contract_id
		LEFT JOIN apartment_contract_relation acr ON acr.contract_id=ac.contract_id
		WHERE acr.apartment_id=#{apartment_id} limit 1
	</select>

	<!-- 查询是否有自营公寓实收租金数据 -->
	<select id="searchApartmentContractReceipts" parameterType="java.lang.String" resultType="java.lang.Integer">
		SELECT 1 FROM apartment_contract_receipts cr 
		INNER JOIN apartment_contract ac ON ac.contract_id=cr.contract_id
		LEFT JOIN apartment_contract_relation acr ON acr.contract_id=ac.contract_id
		WHERE acr.apartment_id=#{apartment_id} limit 1
	</select>
	<!-- 插入一条数据 -->
	<insert id="insertApartment" parameterType="com.isz.erp.facade.house.entity.Apartment">
		INSERT INTO `apartment`
		(apartment_id,residential_id,building_id,house_contract_id,house_id,room_id,city_code,area_code,apartment_code,apartment_type,
		rent_type,rent_status,look_type,look_date,look_remark,fitment_cost,entrust_cost,capital_cost,apartment_cost,rent_price,
		did,uid,remark,is_active,online_status,online_uid,online_time,web_manager_uid,activated_type,
		activated_time,activated_uid,fire_status,deleted,service_uid,service_did,check_in_date,fitment_type,
		create_time,create_uid,update_time,update_uid,property,category,dealtype,cost_account,vacancy_date)
		VALUES
		(#{apartment_id},#{residential_id},#{building_id},#{house_contract_id},#{house_id},#{room_id},#{city_code},#{area_code},#{apartment_code},#{apartment_type},
		#{rent_type},#{rent_status},#{look_type},#{look_date},#{look_remark},#{fitment_cost},#{entrust_cost},#{capital_cost},#{apartment_cost},#{rent_price},
		#{did},#{uid},#{remark},#{is_active},#{online_status},#{online_uid},#{online_time},#{web_manager_uid},#{activated_type},
		#{activated_time},#{activated_uid},#{fire_status},#{deleted},#{service_uid},#{service_did},#{check_in_date},#{fitment_type},
		#{create_time},#{create_uid},#{update_time},#{update_uid},#{property},#{category},#{dealtype},#{cost_account},#{vacancy_date})
	</insert>
	<!-- 未删除的房源公寓 -->
	<select id="selectByHouseIdContractId"
		parameterType="java.util.Map" resultType="com.isz.erp.facade.house.entity.Apartment">
		SELECT
			a.apartment_id,
			a.residential_id,
			a.building_id,
			a.house_contract_id,
			a.house_id,
			a.room_id,
			a.city_code,
			a.area_code,
			a.apartment_code,
			a.apartment_type,
			a.rent_type,
			a.rent_status,
			a.property,
			a.category,
			a.dealtype,
			a.look_type,
			a.look_date,
			a.look_remark,
			a.fitment_cost,
			a.entrust_cost,
			a.capital_cost,
			a.apartment_cost,
			a.rent_price,
			asu.dep_id as did,
			a.uid,
			a.remark,
			a.is_active,
			a.online_status,
			a.online_uid,
			a.online_time,
			a.web_manager_uid,
			a.activated_type,
			a.activated_time,
			a.activated_uid,
			a.fire_status,
			a.deleted,
			a.service_uid,
			a.service_did,
			a.check_in_date,
			a.fitment_type,
			a.create_time,
			a.create_uid,
			a.update_time,
			a.update_uid
		FROM
			apartment AS a
		inner join sys_user asu on asu.user_id=a.uid
		WHERE
			a.house_id=#{house_id} AND a.house_contract_id=#{contract_id} AND a.rent_type='ENTIRE' AND
			a.deleted=0
	</select>
	<!-- 未删除的合租房源公寓 -->
	<select id="selectByRoomIdContractId"
		parameterType="java.util.Map" resultType="com.isz.erp.facade.house.entity.Apartment">
		SELECT
			a.apartment_id,
			a.residential_id,
			a.building_id,
			a.house_contract_id,
			a.house_id,
			a.room_id,
			a.city_code,
			a.area_code,
			a.apartment_code,
			a.apartment_type,
			a.rent_type,
			a.rent_status,
			a.property,
			a.category,
			a.dealtype,
			a.look_type,
			a.look_date,
			a.look_remark,
			a.fitment_cost,
			a.entrust_cost,
			a.capital_cost,
			a.apartment_cost,
			a.rent_price,
			asu.dep_id as did,
			a.uid,
			a.remark,
			a.is_active,
			a.online_status,
			a.online_uid,
			a.online_time,
			a.web_manager_uid,
			a.activated_type,
			a.activated_time,
			a.activated_uid,
			a.fire_status,
			a.deleted,
			a.service_uid,
			su.dep_id as service_did,
			a.check_in_date,
			a.fitment_type,
			a.create_time,
			a.create_uid,
			a.update_time,
			a.update_uid
		FROM
			apartment AS a
		inner join sys_user asu on asu.user_id=a.uid
		left join sys_user su on su.user_id=a.service_uid
		WHERE
			a.house_contract_id=#{contract_id} AND a.rent_type='SHARE' AND
			a.deleted=0
			<if test="null != room_id and '' != room_id">
				AND a.room_id=#{room_id}
			</if>
		ORDER BY (substring_index(a.apartment_code, '-', -1) + 0) DESC LIMIT 1
	</select>
	<!-- 未删除的公寓 -->
	<select id="selectByHouseId" parameterType="java.lang.String" resultType="java.lang.Integer">
	select 
		count(*) 
	from apartment as a 
	INNER JOIN house_contract hc ON hc.house_id = a.house_id
	AND hc.contract_id = a.house_contract_id
	AND hc.is_active = 'Y'
	AND hc.deleted = 0
	where a.house_id=#{house_id} AND a.deleted=0 AND a.is_active="Y"
	</select>
	<!-- 删除合租房源 -->
	<update id="deleteByHouseIdAndRoomId" parameterType="java.util.Map">
		UPDATE apartment a
		INNER JOIN house h ON h.house_id=a.house_id
		SET a.`deleted`=1, a.is_active='N', a.update_time=#{update_time}, a.update_uid=#{update_uid}
		WHERE a.room_id=#{room_id} AND a.house_id=#{house_id} AND a.room_id IS NOT NULL
	</update>
	<!-- 根据委托合同ID返回当前委托合同下的所有公寓 -->
	<select id="selectByHouseContractId"
			parameterType="java.lang.String" resultType="com.isz.erp.facade.house.entity.Apartment">
		SELECT
		a.apartment_id,
		a.residential_id,
		a.building_id,
		a.house_contract_id,
		a.house_id,
		a.room_id,
		a.city_code,
		a.area_code,
		a.apartment_code,
		a.apartment_type,
		a.rent_type,
		a.rent_status,
		a.property,
		a.category,
		a.dealtype,
		a.look_type,
		a.look_date,
		a.look_remark,
		a.fitment_cost,
		a.entrust_cost,
		a.capital_cost,
		a.apartment_cost,
		a.rent_price,
		asu.dep_id as did,
		a.uid,
		a.remark,
		a.is_active,
		a.online_status,
		a.online_uid,
		a.online_time,
		a.web_manager_uid,
		a.activated_type,
		a.activated_time,
		a.activated_uid,
		a.fire_status,
		a.deleted,
		a.service_uid,
		a.service_did,
		a.check_in_date,
		a.fitment_type,
		a.create_time,
		a.create_uid,
		a.update_time,
		a.update_uid,
		a.cost_account
		FROM
		  apartment AS a
		  inner join sys_user asu on asu.user_id=a.uid
		WHERE
		  a.house_contract_id=#{contract_id}
		  AND
		  a.deleted=0
		ORDER BY a.create_time DESC
	</select>
	<!-- 根据委托合同ID返回出租房源的所有公寓 -->
	<select id="selectAllByHouseId"
			parameterType="java.lang.String" resultType="com.isz.erp.facade.house.entity.Apartment">
		SELECT
		a.apartment_id,
		a.residential_id,
		a.building_id,
		a.house_contract_id,
		a.house_id,
		a.room_id,
		a.city_code,
		a.area_code,
		a.apartment_code,
		a.apartment_type,
		a.rent_type,
		a.rent_status,
		a.property,
		a.category,
		a.dealtype,
		a.look_type,
		a.look_date,
		a.look_remark,
		a.fitment_cost,
		a.entrust_cost,
		a.capital_cost,
		a.apartment_cost,
		a.rent_price,
		asu.dep_id as did,
		a.uid,
		a.remark,
		a.is_active,
		a.online_status,
		a.online_uid,
		a.online_time,
		a.web_manager_uid,
		a.activated_type,
		a.activated_time,
		a.activated_uid,
		a.fire_status,
		a.deleted,
		a.service_uid,
		su.dep_id as service_did,
		a.check_in_date,
		a.fitment_type,
		a.create_time,
		a.create_uid,
		a.update_time,
		a.update_uid,
		a.cost_account
		FROM
		 apartment AS a
		inner join sys_user asu on asu.user_id= a.uid
		left join sys_user su on su.user_id=a.service_uid
		WHERE
			a.house_id=(SELECT house_id FROM apartment WHERE deleted=0 AND house_contract_id=#{contract_id} LIMIT 1)
		AND
		a.deleted=0
		ORDER BY a.create_time DESC
	</select>
	<!-- 批量更新公寓状态 -->
	<update id="batchApartmentExpire" parameterType="java.lang.String">
		update Apartment set deleted=1 where house_contract_id in (#{house_contract_id})
	</update>
	<!-- 根据委托合同id和房源编号查找apartment -->
	<select id="selectApartmentByContractIdAndHouseCode" resultType="java.lang.Integer">
	select count(1) from apartment where house_contract_id=(#{0}) and apartment_code=#{1}
	 </select>
	<!-- 根据小区ID获取所有房源信息 -->
	<select id="searchApiApartment" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
			a.house_id houseId,
			r.residential_name premName,
			rb.building_name buildingName,
			h.unit unitName,
			h.house_no houseNo,
			sdi.dict_value roomNum
		FROM apartment a
		INNER JOIN house h ON a.house_id=h.house_id
		INNER JOIN residential r ON r.residential_id=h.residential_id
		INNER JOIN residential_building rb ON rb.building_id=h.building_id
		LEFT JOIN house_room hr On hr.room_id=a.room_id AND hr.deleted=0
		LEFT JOIN sys_dict_item sdi ON sdi.dict_code='RoomNo' AND sdi.dict_key=hr.room_no
		WHERE a.deleted=0 AND a.is_active='Y' AND h.deleted=0 
			AND r.residential_id=#{premId}
		ORDER BY rb.building_name, h.unit, h.house_no
	</select>
	<select id="selectListByHouseId" parameterType="java.lang.String" resultType="com.isz.erp.facade.house.entity.Apartment">
		SELECT * FROM apartment WHERE deleted=0 AND is_active='Y' AND house_id=#{house_id}
	</select>
	
		<!-- 根据apartmentID查询官网维护人 -->
	<select id="selectApartmentWebUser" parameterType="java.lang.String" resultType="com.isz.erp.facade.user.entity.SysUser">
		SELECT
			s.*, sd.business_type
		FROM
			apartment a
		LEFT JOIN house_contract ac ON ac.house_id = a.house_id AND ac.is_active = 'Y'
		LEFT JOIN sys_user s ON ac.sign_uid = s.user_id
		LEFT JOIN sys_department sd ON s.dep_id = sd.dep_id
		WHERE
			a.apartment_id = #{0}
			LIMIT 0,1
	</select>

	<!-- 预定房源 整租合租列表 -->
	<select id="countSearchBookAvailabilityApartment" parameterType="java.util.Map" resultType="java.lang.Integer">
		SELECT COUNT(1) <include refid="bookAvailabilityApartmentSQL"></include>
	</select>
	<select id="searchBookAvailabilityApartmentList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
			a.apartment_id,
			a.house_id,
			a.rent_status,
			a.category,
			a.property,
			a.category,
			a.dealtype,
			a.apartment_code,
			CONCAT_WS('',r.residential_name,rb.building_name,IFNULL(sdi.dict_value,''),CASE h.unit WHEN '无' THEN '' ELSE IFNULL(h.unit , '') END,h.house_no,'室',IFNULL(sdi2.dict_value,'')) property_address,
			'APARTMENT' object_type,
			a.apartment_type,
			a.rent_type,
			a.rent_price,
			asu.dep_id as did,
			a.uid,
			sd.dep_name did_name,
			su.user_name uid_name,
			a.update_time,
			sd1.name city_name,
			sd2.name area_name,
			r.residential_name residential_name,
			rb.building_name building_name,
			rb.suffix suffix,
			CASE h.unit WHEN '无' THEN '' ELSE IFNULL(h.unit,'') END unit,
			h.house_no house_no,
			hr.room_no room_no,
			hr.room_id,
			(
			SELECT
			GROUP_CONCAT(bc.business_circle_name) as business_circle_names
			FROM
			business_circle bc
			LEFT JOIN residential_business_circle rbc ON bc.business_circle_id = rbc.business_circle_id
			where rbc.residential_id = h.residential_id
			)  as business_circle_multi
			<include refid="bookAvailabilityApartmentSQL"></include>
			<if test="null != sort and sort != ''">
				ORDER BY ${sort}
				<if test="null != order and order != ''">
					${order}
				</if>
			</if>
	</select>
	<sql id="bookAvailabilityApartmentSQL">
		FROM apartment a
		inner join sys_user asu on a.uid=asu.user_id
		INNER JOIN house_contract hc ON hc.contract_id=a.house_contract_id
		INNER JOIN house h ON h.house_id=a.house_id
		INNER JOIN residential r ON a.residential_id=r.residential_id
		INNER JOIN residential_building rb ON a.building_id=rb.building_id
		LEFT JOIN sys_dict_item sdi ON sdi.dict_code='Suffix' AND sdi.dict_e_value=rb.suffix
		LEFT JOIN house_room hr ON hr.room_id=a.room_id
		LEFT JOIN sys_dict_item sdi2 ON sdi2.dict_code='RoomNo' AND sdi2.dict_e_value=hr.room_no
		<!-- LEFT JOIN sys_department sd ON sd.dep_id=hc.sign_did -->
		
		LEFT JOIN sys_user su ON su.user_id=hc.sign_uid
		left join sys_department sd on su.dep_id=sd.dep_id
		LEFT JOIN sys_district sd1 ON sd1.code=a.city_code
		LEFT JOIN sys_district sd2 ON sd2.code=a.area_code
		<where>
			<trim prefixOverrides="and">
				and a.deleted=0 and hc.is_active='Y' and hc.deleted=0
				<if test="null != residential_name_house_code_search and '' != residential_name_house_code_search">
					and (r.residential_name like CONCAT('%','${residential_name_house_code_search}','%')
					or a.apartment_code like CONCAT('%','${residential_name_house_code_search}','%')
					or r.byname like CONCAT('%','${residential_name_house_code_search}','%' )
					or r.address like CONCAT('%','${residential_name_house_code_search}','%' )
					)
				</if>
				<if test="null != building_name_search and '' != building_name_search">
					and rb.building_name like CONCAT('%','${building_name_search}','%')
				</if>
				<if test="null != unit_search and '' != unit_search">
					and h.unit like CONCAT('%','${unit_search}','%')
				</if>
				<if test="null != house_no_search and '' != house_no_search">
					and h.house_no like CONCAT('%','${house_no_search}','%')
				</if>
				<if test="null != rent_type_search and '' != rent_type_search">
					and a.rent_type=#{rent_type_search}
				</if>
				<if test="null != city_code_search and '' != city_code_search">
					and a.city_code in (${city_code_search})
				</if>
				<if test="null != status_sql_search and '' != status_sql_search">
					and (${status_sql_search})
				</if>
			</trim>
		</where>
	</sql>

	<!-- 待定价房源列表 -->
	<select id="searchPricingApartment" parameterType="java.lang.String" resultType="java.util.Map">
		SELECT
			a.apartment_id,
			hr.room_no,
			hr.room_orientation,
			hr.room_area,
			(
				SELECT GROUP_CONCAT(DISTINCT(sdi.dict_value))
				FROM house_room_func hrf INNER JOIN sys_dict_item sdi ON hrf.func_type=sdi.dict_e_value AND sdi.dict_code='HouseRoomFuncType'
				WHERE hrf.room_id=a.room_id
			) func_type_desc
		 FROM apartment a
		 INNER JOIN house_room hr ON hr.room_id=a.room_id
		 LEFT JOIN house_room_func  hrf ON hrf.room_id=a.room_id
		 WHERE a.deleted=0 AND a.house_contract_id = (SELECT house_contract_id FROM apartment WHERE apartment_id=#{apartment_id})
		 GROUP BY a.apartment_id
	</select>

	<!-- 更新出租状态或房源类别 -->
	<update id="updateApartmentStatusCategory" parameterType="com.isz.erp.facade.house.entity.Apartment">
		UPDATE apartment a SET a.update_time=#{update_time},a.update_uid=#{update_uid}
		<if test="null != rent_status and '' != rent_status">
			,a.rent_status=#{rent_status}
		</if>
		<if test="null != category">
			,a.category=#{category}
		</if>
		WHERE a.apartment_id=#{apartment_id}
	</update>

	<select id="searchApiApartmentByContract" parameterType="java.util.Map" resultType="java.util.Map">
		select a.apartment_id apartmentId,a.apartment_code apartmentCode from apartment a
		inner join apartment_contract_relation acr on acr.apartment_id=a.apartment_id
		inner join apartment_contract ac on ac.contract_id=acr.contract_id
		where ac.deleted=0 and <![CDATA[ac.contract_status <> 'CANCEL']]> and a.deleted=0 
		<if test="null != contract_id and '' != contract_id">
			and ac.contract_id=#{contract_id}
		</if>
		<if test="null != contract_num and '' != contract_num">
			and ac.contract_num=#{contract_num}
		</if>
	</select>

	<select id="selectWaitingRentList" resultType="com.isz.erp.facade.house.vo.ApartmentVo">
		SELECT
			a.apartment_id,
			a.house_id,
			a.room_id,
			hc.contract_id,
			hc.contract_type,
			hc.apartment_type,
			hc.entrust_start_date,
			hc.entrust_end_date,
			hc.entrust_type,
			fh.set_delivery_date,
			case when p_a.apartment_id is null then a.apartment_id else p_a.apartment_id end  parent_apartment_id,
			p_hc.contract_id parent_contract_id,
			p_hc.contract_type parent_contract_type,
			p_hc.apartment_type parent_apartment_type,
			p_hc.entrust_start_date parent_entrust_start_date,
			p_hc.entrust_end_date parent_entrust_end_date,
			p_hc.entrust_type parent_entrust_type,
			p_fh.set_delivery_date parent_set_delivery_date
		FROM apartment a
		INNER JOIN house_contract hc ON hc.contract_id=a.house_contract_id AND hc.is_active='Y' AND hc.deleted=0 AND hc.entrust_start_date IS NOT NULL AND hc.entrust_end_date IS NOT NULL
		LEFT JOIN fitment_house fh ON a.house_id=fh.house_id AND fh.contract_id=a.house_contract_id
		LEFT JOIN house_contract p_hc ON p_hc.contract_id=hc.parent_id AND hc.deleted=0 AND p_hc.entrust_start_date IS NOT NULL AND p_hc.entrust_end_date IS NOT NULL
		LEFT JOIN apartment p_a on p_a.house_contract_id = p_hc.contract_id and p_a.deleted=0 and 
		  (a.room_id=p_a.room_id or (a.room_id is null and p_a.room_id is null))
		LEFT JOIN fitment_house p_fh ON p_fh.house_id=a.house_id AND p_fh.contract_id=hc.parent_id
		WHERE a.rent_status='WAITING_RENT' AND a.deleted=0
	</select>
	
	<update id="updateFireStatus" parameterType="java.util.Map">
		UPDATE apartment SET fire_status=#{fire_status},fire_days=NULL WHERE deleted=0 AND (rent_status='RENTED' OR rent_status='BOOKED') AND (fire_status != #{fire_status} OR fire_days IS NOT NULL)
	</update>
	<select id="searchApartmentListBySolr" parameterType="java.util.Map" resultMap="plusApartmentMap">
		select
		a.house_contract_id,
		a.room_id,
		hr.room_code,
		ohi.audit_status as issure_audit_status,
		a.apartment_id as id,
		a.residential_id,
		a.building_id,
		a.house_id,
		a.room_id,
		a.apartment_code,
		a.apartment_type,
		a.rent_type,
		a.rent_status,
		a.property,
		a.category,
		a.dealtype,
		a.fire_status,
		fh.fitment_status,
		fh.fitment_style,
		date_format(a.look_date,'%Y-%m-%d %T') as look_date,
		a.look_type,
		a.city_code,
		a.area_code,
		a.online_status,
		a.online_time,
		a.online_uid,
		a.activated_time,
		a.activated_type,
		a.activated_uid,
		a.fitment_cost,
		a.entrust_cost,
		a.capital_cost,
		a.apartment_cost,
		a.rent_price,
		suu.dep_id did,
		a.uid,
		a.remark,
		a.create_time,
		a.update_time,
		a.create_uid,
		a.deleted,
		r.residential_name,
		r.byname,
		r.address,
		r.lng,
		r.lat,
		CONCAT(r.lat,',',r.lng) AS geohashs,
		sd.`name` AS area_name,
		h.house_code,
		hr.room_no,
		case a.rent_type when 'ENTIRE' then
		h.orientation
		ELSE
		hr.room_orientation
		END orientation,
		case a.rent_type when 'ENTIRE' then
		h.build_area
		ELSE
		hr.room_area
		END build_area,
		a.fitment_type,
		hc.sign_uid,
		su.dep_id sign_did,
		date_format(hc.delay_date,'%Y-%m-%d %T') as delay_date,
		su.user_name AS signusername,
		a.look_remark,
		sysd.dep_name AS signdeptname,
		CASE WHEN a.rent_type ='ENTIRE' AND a.apartment_type='MANAGE' THEN
		(
		SELECT
		GROUP_CONCAT(CONCAT('http://img.ishangzu.com/',im.src))
		FROM
		house r1
		LEFT JOIN house_img rmi ON rmi.house_id = r1.house_id
		LEFT JOIN image im ON im.img_id=rmi.img_id
		WHERE
		rmi.deleted = 0
		AND r1.house_id = a.house_id
		AND rmi.img_type = 'INDOOR_IMGS'
		)
		WHEN a.rent_type = 'ENTIRE' THEN
		(
		SELECT
		GROUP_CONCAT(
		CONCAT(
		'http://img.ishangzu.com/',
		im.src
		)
		)
		FROM
		house_room r1
		LEFT JOIN house_room_img rmi ON rmi.room_id = r1.room_id
		LEFT JOIN image im ON im.img_id = rmi.img_id
		WHERE
		rmi.deleted = 0
		AND r1.house_id = a.house_id
		AND rmi.img_type = 'INDOOR_IMGS'
		ORDER BY
		r1.public_flag ASC
		)
		ELSE
		(SELECT
		GROUP_CONCAT(CONCAT('http://img.ishangzu.com/',im.src))
		FROM
		house_room r1
		LEFT JOIN house_room_img rmi ON rmi.room_id=r1.room_id
		LEFT JOIN image im ON im.img_id=rmi.img_id
		where  rmi.deleted=0 AND r1.room_id=a.room_id AND rmi.img_type='INDOOR_IMGS'
		ORDER BY r1.public_flag ASC
		)
		END as indoor_imgs ,

		CASE WHEN a.rent_type ='ENTIRE' AND a.apartment_type='MANAGE' THEN
		(
		SELECT
		GROUP_CONCAT(CONCAT('http://img.ishangzu.com/',im.src))
		FROM
		house r1
		LEFT JOIN house_img rmi ON rmi.house_id = r1.house_id
		LEFT JOIN image im ON im.img_id=rmi.img_id
		WHERE
		rmi.deleted = 0
		and r1.house_id = a.house_id
		AND rmi.img_type = 'HOUSE_IMGS'
		)
		ELSE
		(
		SELECT
		GROUP_CONCAT(CONCAT('http://img.ishangzu.com/',im.src))
		FROM
		house_room r1
		LEFT JOIN house_room_img rmi ON rmi.room_id=r1.room_id
		LEFT JOIN image im ON im.img_id=rmi.img_id
		where  rmi.deleted=0 AND r1.house_id=a.house_id AND rmi.img_type='HOUSE_IMGS'
		)
		END as house_imgs ,
		case a.rent_type when 'ENTIRE' then
		(CASE
		WHEN
		a.apartment_type = 'MANAGE'
		THEN
		(SELECT
		COUNT(house_img_id) apartment_img_count
		FROM
		house_img hi
		WHERE
		hi.house_id = h.house_id
		AND hi.deleted = 0)
		ELSE (SELECT
		COUNT(room_img_id) apartment_img_count
		FROM
		house_room_img hri
		WHERE
		hri.house_id = a.house_id
		AND hri.deleted = 0)
		END)
		else
		(
		SELECT
		COUNT(room_img_id)
		FROM
		house_room_img hri
		WHERE
		hri.room_id = a.room_id
		AND hri.deleted = 0
		)
		end apartment_img_count,
		case a.rent_type when 'ENTIRE' then
		(CASE
		WHEN
		a.apartment_type = 'MANAGE'
		THEN
		(SELECT
		COUNT(house_img_id)
		FROM
		house_img hi
		WHERE
		hi.house_id = h.house_id
		AND hi.deleted = 0)
		ELSE (SELECT
		COUNT(room_img_id)
		FROM
		house_room_img hri
		WHERE
		hri.house_id = a.house_id
		AND hri.deleted = 0)
		END)
		else
		(
		(SELECT
		COUNT(room_img_id)
		FROM
		house_room_img hri
		WHERE
		hri.room_id = a.room_id
		AND hri.deleted = 0
		)+
		(SELECT
		count(1)
		FROM
		house_room_img hri
		, house_room hr where hr.room_id = hri.room_id
		AND hr.public_flag = 'Y'
		AND hr.house_contract_id = a.house_contract_id
		AND hr.house_id = a.house_id
		)) end as apartment_img_con_public_count,
		(SELECT
		date_format(MAX(follow_date),'%Y-%m-%d %T') as apartment_follow_time
		FROM
		follow
		WHERE
		object_type = 'APARTMENT'
		and deleted=0
		and follow_type!='SYSTEMEDIT'
		and object_id = a.apartment_id) as apartment_follow_time,
		rb.ground_floors,
		rb.building_name,
		rb.suffix,
		rb.house_role,
		h.unit,
		h.house_no,
		h.floor,
		CONCAT(h.floor, '|', rb.underground_floors + rb.ground_floors) AS floor_floors,
		h.property_type,
		h.property_use,
		(SELECT
		date_format(MAX(ac.rent_end_date),'%Y-%m-%d %T') AS rent_end_date
		FROM
		apartment_contract ac
		LEFT JOIN
		apartment_contract_relation acr ON acr.contract_id = ac.contract_id

		WHERE
		ac.deleted = 0 and <![CDATA[ac.contract_status <> 'CANCEL']]>
		AND (ac.contract_status = 'EFFECTIVE'
		OR ac.contract_status = 'CONTINUED')
		and acr.apartment_id = a.apartment_id
		) as rent_end_date,

		date_format(hc.entrust_end_date,'%Y-%m-%d %T') AS entrust_end_date,
		date_format(hc.create_time,'%Y-%m-%d %T') AS house_contract_create_time,
		CASE a.apartment_type
		WHEN 'MANAGE' THEN 'UNRRESTYLE'
		WHEN 'BRAND' THEN fh.reform_way
		ELSE ''
		END reform_way,
		CASE a.apartment_type
		WHEN 'MANAGE' THEN 'MANAGE'
		WHEN 'BRAND' THEN fh.apartment_kind
		ELSE ''
		END apartment_kind,
		case a.rent_type when 'ENTIRE' then
		(CASE
		WHEN
		a.apartment_type = 'MANAGE'
		THEN h.rooms
		WHEN 'BRAND' THEN fh.rooms
		ELSE 0 END)
		WHEN 'SHARE' THEN fh.rooms ELSE 0
		END rooms,
		case a.rent_type when 'ENTIRE' then
		(CASE
		WHEN
		a.apartment_type = 'MANAGE'
		THEN h.livings
		WHEN 'BRAND' THEN fh.livings
		ELSE 0 END)
		WHEN 'SHARE' THEN fh.livings ELSE 0
		END livings,
		case a.rent_type when 'ENTIRE' then
		(CASE
		WHEN
		a.apartment_type = 'MANAGE'
		THEN h.kitchens
		WHEN 'BRAND' THEN fh.kitchens
		ELSE 0 END)
		WHEN 'SHARE' THEN fh.kitchens ELSE 0
		END kitchens,
		case a.rent_type when 'ENTIRE' then
		(CASE
		WHEN
		a.apartment_type = 'MANAGE'
		THEN h.bathrooms
		WHEN 'BRAND' THEN fh.bathrooms
		ELSE 0 END)
		WHEN 'SHARE' THEN fh.bathrooms ELSE 0
		END bathrooms,
		case a.rent_type when 'ENTIRE' then
		(CASE
		WHEN
		a.apartment_type = 'MANAGE'
		THEN h.balconys
		WHEN 'BRAND' THEN fh.balconys
		ELSE 0 END)
		WHEN 'SHARE' THEN fh.balconys ELSE 0
		END balconys,
		serviceu.user_name AS serviceusername,
		a.service_uid,
		serviceu.dep_id service_did,
		(SELECT
		d.name
		FROM
		sys_district d
		WHERE
		d.code = a.city_code) AS city_name,
		(SELECT
		GROUP_CONCAT(DISTINCT(sdi.dict_value))
		FROM
		sys_dict_item sdi
		INNER JOIN
		house_room_feature hrf ON hrf.feature_code = sdi.dict_e_value
		AND sdi.is_active = '1'
		WHERE
		hrf.room_id = a.room_id) house_room_feature_multi,
		(SELECT
		GROUP_CONCAT(DISTINCT(sdi.dict_e_value))
		FROM
		sys_dict_item sdi
		INNER JOIN
		house_room_feature hrf ON hrf.feature_code = sdi.dict_e_value
		AND sdi.is_active = '1'
		WHERE
		hrf.room_id = a.room_id GROUP BY a.room_id) house_room_feature_ids,
		bcm.business_circle_multi,
		bcm.business_circle_ids,
		rrd.residential_dept_response,
		rrd.dids,
		CASE a.rent_type
		WHEN 'ENTIRE' THEN
		(
		SELECT
		cp.gender
		FROM
		apartment_contract_relation acr
		INNER JOIN apartment_contract ac ON acr.contract_id = ac.contract_id and ac.deleted = 0 and <![CDATA[ac.contract_status <> 'CANCEL']]> and ac.is_active = 'Y'
		INNER JOIN customer_person cp ON cp.person_id = ac.person_id
		WHERE
		acr.apartment_id = a.apartment_id
		AND acr.house_id = a.house_id
		ORDER BY ac.create_time ASC
		LIMIT 1
		)
		ELSE
		(
		SELECT
		cp.gender
		FROM
		apartment_contract_relation acr
		INNER JOIN apartment_contract ac ON acr.contract_id = ac.contract_id and ac.deleted = 0 and <![CDATA[ac.contract_status <> 'CANCEL']]> and ac.is_active = 'Y'
		INNER JOIN customer_person cp ON cp.person_id = ac.person_id
		WHERE
		acr.apartment_id = a.apartment_id
		AND acr.house_id = a.house_id
		AND acr.room_id = a.room_id
		ORDER BY ac.create_time ASC
		LIMIT 1
		)
		end  AS customer_person_gender,
		CASE a.rent_type
		WHEN 'ENTIRE' THEN
		(
		SELECT
		cp.birth_date
		FROM
		apartment_contract_relation acr
		INNER JOIN apartment_contract ac ON acr.contract_id = ac.contract_id and ac.deleted = 0 and ac.is_active = 'Y'
		INNER JOIN customer_person cp ON cp.person_id = ac.person_id
		WHERE
		acr.apartment_id = a.apartment_id
		AND acr.house_id = a.house_id
		ORDER BY ac.create_time ASC
		LIMIT 1
		)
		ELSE
		(
		SELECT
		cp.birth_date
		FROM
		apartment_contract_relation acr
		INNER JOIN apartment_contract ac ON acr.contract_id = ac.contract_id and ac.deleted = 0 and ac.is_active = 'Y'
		INNER JOIN customer_person cp ON cp.person_id = ac.person_id
		WHERE
		acr.apartment_id = a.apartment_id
		AND acr.house_id = a.house_id
		AND acr.room_id = a.room_id
		ORDER BY ac.create_time ASC
		LIMIT 1
		)
		end  AS customer_person_birth_date,
		a.web_manager_uid,
		su1.user_name AS web_manager_uname,
		su1.user_phone AS web_manager_uphone,
		su1.dep_id AS web_manager_did,
		sysm.dep_name AS web_manager_name,
		sysp.position_name AS web_manager_position_name,
		hc.payment_cycle,
		a.fire_days,
		ohi.audit_status as issure_audit_status ,
		conv(right((SELECT did from residential_department WHERE residential_id=a.residential_id LIMIT 1),12),16,10) as did_binary,
		conv(right((SELECT sd.parent_id from residential_department rd LEFT JOIN sys_department sd ON sd.dep_id=rd.did WHERE residential_id=a.residential_id LIMIT 1),12),16,10) as pdid_binary,
		CONCAT(r.residential_name,IFNULL(rb.building_name,''),IFNULL((select dict_value from sys_dict_item where dict_code='Suffix' AND dict_key=rb.suffix),''),CASE h.unit WHEN '无' THEN '' ELSE IFNULL(h.unit,'') END,IFNULL(h.house_no,''),'室') as house_address,
		CONCAT(r.residential_name,IFNULL(rb.building_name,''),IFNULL((select dict_value from sys_dict_item where dict_code='Suffix' AND dict_key=rb.suffix),'')) as residential_building_name
		FROM
		apartment a

		JOIN residential r ON a.residential_id = r.residential_id
		JOIN residential_building rb ON a.building_id = rb.building_id
		JOIN house h ON a.house_id = h.house_id
		LEFT JOIN sys_district sd ON a.area_code = sd.code
		LEFT JOIN sys_district sd_city ON a.city_code = sd_city.code
		left JOIN house_room hr ON a.room_id = hr.room_id AND hr.deleted = 0 AND hr.is_active = 'Y'
		INNER JOIN house_contract hc ON hc.house_id = h.house_id
		AND hc.contract_id = a.house_contract_id
		AND hc.is_active = 'Y'
		AND hc.deleted = 0
		LEFT JOIN sys_user suu ON suu.user_id=a.uid
		LEFT JOIN sys_user su ON hc.sign_uid = su.user_id
		LEFT JOIN sys_department sysd ON su.dep_id = sysd.dep_id
		LEFT JOIN sys_user serviceu ON serviceu.user_id = a.service_uid
		LEFT JOIN sys_department syss ON syss.dep_id = serviceu.dep_id
		LEFT JOIN fitment_house fh ON fh.house_id = hc.house_id AND fh.contract_id = hc.contract_id
		LEFT JOIN sys_user su1 ON a.web_manager_uid=su1.user_id
		LEFT JOIN sys_department sysm ON sysm.dep_id = su1.dep_id
		LEFT JOIN sys_position sysp ON sysp.position_id=su1.position_id

		left join (SELECT
		GROUP_CONCAT(bc.business_circle_name) business_circle_multi,concat(',',GROUP_CONCAT(bc.business_circle_id),',') as business_circle_ids,rbc.residential_id
		FROM
		business_circle bc
		LEFT JOIN residential_business_circle rbc ON bc.business_circle_id = rbc.business_circle_id group by rbc.residential_id) bcm
		on bcm.residential_id=a.residential_id

		left join
		(SELECT
		GROUP_CONCAT(sd1.dep_name) residential_dept_response, concat(',',GROUP_CONCAT(DISTINCT(rd1.did)),',') dids,rd1.residential_id
		FROM
		residential_department rd1
		LEFT JOIN sys_department sd1 ON rd1.did = sd1.dep_id group by rd1.residential_id) rrd
		on
		rrd.residential_id = r.residential_id

		left JOIN online_house_info ohi ON ohi.apartment_id=a.apartment_id
		where a.deleted=0 and a.is_active = 'Y'
			    
				<if test="apartment_id != null and '' !=  apartment_id">
					 and a.apartment_id = #{apartment_id}
				</if>
				<if test="apartment_update_solr != null and '' !=  apartment_update_solr">
					and a.apartment_id IN (
						SELECT DISTINCT apartment_id FROM (
							<include refid="apartmentUpdateSolrSQL"></include>
						) uu
					)
				</if>
			limit ${offset},${limit}

	</select>
	
	<select id="searchApartmentListCountBySolr" parameterType="java.util.Map" resultType="java.lang.Integer">
		
			SELECT 
			    count(1)
			FROM
			    apartment a
			      
			        INNER JOIN
			    house_contract hc ON hc.house_id = a.house_id
			        AND hc.contract_id = a.house_contract_id
			        AND hc.is_active = 'Y'
			        AND hc.deleted = 0
			      
			WHERE
			    a.deleted = 0 AND a.is_active = 'Y'

	</select>
	
	<select id="searchApartmentDeleteListBySolr" parameterType="java.util.Map" resultMap="ApartmentMap">
		
			select a.apartment_id as apartment_id from apartment a where  (a.deleted=1 or a.is_active='N') and a.update_time>date_add(now(), interval -2 minute)
 


	</select>
	
	<select id="searchApartmentDeleteListALLCountBySolr" parameterType="java.util.Map" resultType="java.lang.Integer">
			select count(1) from apartment a where  (a.deleted=1 or a.is_active='N')
	</select>
	<select id="searchApartmentDeleteListALLBySolr" parameterType="java.util.Map" resultType="java.lang.String">
			select a.apartment_id as apartment_id from apartment a where  (a.deleted=1 or a.is_active='N')
			limit ${offset},${limit}
	</select>

	<select id="searchApartmentUpdateListCountBySolr" resultType="java.lang.Integer">
		SELECT COUNT(DISTINCT apartment_id) FROM (
			<include refid="apartmentUpdateSolrSQL"></include>
		) uu
	</select>

	<sql id="apartmentUpdateSolrSQL">
		SELECT
					a.apartment_id AS apartment_id
				FROM
					apartment a
				WHERE
					a.deleted = 0
						AND a.update_time > date_add(now(), interval -2 minute)
				UNION SELECT
					a.apartment_id AS apartment_id
				FROM
					apartment a
						JOIN
					residential r ON a.residential_id = r.residential_id
						AND r.update_time > date_add(now(), interval -2 minute)
				WHERE
					a.deleted = 0 AND a.is_active = 'Y'
				UNION SELECT
					a.apartment_id AS apartment_id
				FROM
					apartment a
						JOIN
					residential_building rb ON a.building_id = rb.building_id
						AND rb.update_time > date_add(now(), interval -2 minute)
				WHERE
					a.deleted = 0 AND a.is_active = 'Y'
				UNION SELECT
					a.apartment_id AS apartment_id
				FROM
					apartment a
						JOIN
					house h ON a.house_id = h.house_id
						AND h.deleted = 0
						AND h.update_time > date_add(now(), interval -2 minute)
				WHERE
					a.deleted = 0 AND a.is_active = 'Y'
				UNION SELECT
					a.apartment_id AS apartment_id
				FROM
					apartment a
						INNER JOIN
					house_contract hc ON hc.house_id = a.house_id
						AND hc.contract_id = a.house_contract_id
						AND hc.is_active = 'Y'
						AND hc.deleted = 0
						AND hc.update_time > date_add(now(), interval -2 minute)
				WHERE
					a.deleted = 0 AND a.is_active = 'Y'
				UNION SELECT
					a.apartment_id AS apartment_id
				FROM
					apartment a
						JOIN
					sys_user su ON su.user_id = a.service_uid
						AND su.update_time > date_add(now(), interval -2 minute)
				WHERE
					a.deleted = 0 AND a.is_active = 'Y'
				UNION SELECT
					a.apartment_id AS apartment_id
				FROM
					apartment a
						INNER JOIN
					house_contract hc ON hc.contract_id = a.house_contract_id
					inner join sys_user su on hc.sign_uid =su.user_id
					<!-- 	JOIN
					sys_department sysd ON hc.sign_did = sysd.dep_id
						AND sysd.update_time > date_add(now(), interval -2 minute) -->
					JOIN
				sys_department sysd ON su.dep_id = sysd.dep_id
						AND sysd.update_time > date_add(now(), interval -2 minute) 	
				WHERE
					a.deleted = 0 AND a.is_active = 'Y'
				UNION SELECT
					a.apartment_id AS apartment_id
				FROM
					apartment a
						JOIN
					fitment_house fh ON fh.contract_id = a.house_contract_id
						AND fh.update_time > date_add(now(), interval -2 minute)
				WHERE
					a.deleted = 0 AND a.is_active = 'Y'
				UNION SELECT
					a.apartment_id AS apartment_id
				FROM
					apartment a
						JOIN
					house_room hr ON a.room_id = hr.room_id
						AND hr.deleted = 0
						AND hr.is_active = 'Y'
						AND hr.update_time > date_add(now(), interval -2 minute)
				WHERE
					a.deleted = 0 AND a.is_active = 'Y'
	</sql>

	<select id="searchApartmentUpdateListBySolr" parameterType="java.util.Map" resultMap="ApartmentMap">
		<include refid="apartmentUpdateSolrSQL"></include>
	</select>
	
	<!-- 查询所有的有效公寓 -->
	<select id="getAllValidApartments"  resultType="com.isz.erp.facade.house.entity.Apartment">
		<![CDATA[select hr.* from Apartment hr where hr.deleted=0 and hr.rent_status<>'INVALID']]>
	</select>
	
	<select id="getNeedApartments" resultType="com.isz.erp.facade.house.entity.Apartment">
		<![CDATA[select hr.* from Apartment hr
		inner join sys_user su on su.user_id = hr.web_manager_uid
		inner join sys_department sd on sd.dep_id=su.dep_id
		inner join sheet1 s on s.dep_name = sd.dep_name
		 where hr.deleted=0 and hr.rent_status<>'INVALID'
		]]>
	</select>
	
	<select id="searchValidApartmentByApartmentId" resultType="com.isz.erp.facade.house.entity.Apartment">
			SELECT
				*
			FROM
				apartment a
			INNER JOIN (
				SELECT
					*
				FROM
					apartment
				WHERE
					apartment_id = #{apartment_id}
				AND room_id is null
			) t ON a.house_id = t.house_id
			
			WHERE
				a.deleted = 0
			AND a.is_active = 'Y'
			UNION 
			SELECT
				*
			FROM
				apartment a
			INNER JOIN (
				SELECT
					*
				FROM
					apartment
				WHERE
					apartment_id = #{apartment_id}
			) t ON a.house_id = t.house_id
			and a.room_id = t.room_id
			
			WHERE
				a.deleted = 0
			AND a.is_active = 'Y'
			
			LIMIT 1;
	
	</select>
	
	
	
	
</mapper>
