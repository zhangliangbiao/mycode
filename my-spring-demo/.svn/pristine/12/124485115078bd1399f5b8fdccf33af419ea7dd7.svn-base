<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.isz.erp.house.mapper.HouseRoomMapper">
	<!-- 批量删除 -->
	<update id="deleteByHouseIdContractId" parameterType="java.util.Map">
		UPDATE house_room hr 
		INNER JOIN house h ON h.house_id=hr.house_id
		SET hr.deleted=1, hr.is_active='N', hr.update_time=#{update_time}, hr.update_uid=#{update_uid}
		WHERE h.house_id=#{house_id} AND hr.house_contract_id=#{contract_id}
	</update>
	<!-- 添加记录 -->
	<insert id="insertHouseRoom" parameterType="com.isz.erp.facade.house.entity.HouseRoom">
		INSERT INTO `house_room` 
		(room_id,house_contract_id,house_id,residential_id,building_id,city_code,area_code,room_code,room_no,
		public_flag,room_type,room_area,room_orientation,original_room_type,decoration_style,
		deleted,is_active,create_time,create_uid,update_time,update_uid,fitment_room_id)
		VALUES 
		(#{room_id},#{house_contract_id},#{house_id},#{residential_id},#{building_id},#{city_code},#{area_code},#{room_code},#{room_no},
		#{public_flag},#{room_type},#{room_area},#{room_orientation},#{original_room_type},#{decoration_style},
		#{deleted},#{is_active},#{create_time},#{create_uid},#{update_time},#{update_uid},#{fitment_room_id})
	</insert>
	<!-- 批量删除 -->
	<delete id="deleteByFitmentId" parameterType="java.util.Map">
		UPDATE house_room hr
		INNER JOIN fitment_room fr ON fr.room_id=hr.room_id
		INNER JOIN fitment_house fh ON fh.fitment_id=fr.fitment_id
		SET hr.deleted=1, hr.is_active='N', hr.update_time=#{update_time}, hr.update_uid=#{update_uid}
		WHERE fh.fitment_id=#{fitment_id}
	</delete>
	<!-- 是否有有效的出租合同 -->
	<select id="selectSignedByHouseAndRoom" parameterType="java.util.Map" resultType="java.lang.String">
		SELECT DISTINCT(ac.contract_id)
		FROM apartment_contract ac 
		INNER JOIN apartment_contract_relation acr ON ac.contract_id=acr.contract_id
		INNER JOIN apartment a ON acr.apartment_id=a.apartment_id
		WHERE a.rent_type='SHARE' AND a.is_active='Y' AND a.deleted=0 AND ac.is_active='Y'  
		AND ac.deleted=0 and <![CDATA[ac.contract_status <> 'CANCEL']]> AND acr.room_id=#{room_id} AND acr.house_id=#{house_id}
	</select>
	<!-- 同通过fitment_room_id删除 -->
	<update id="deleteByHouseIdAndRoomId" parameterType="java.util.Map">
		UPDATE house_room hr 
		INNER JOIN house h ON h.house_id=hr.house_id
		SET hr.deleted=1, hr.is_active='N', hr.update_time=#{update_time}, hr.update_uid=#{update_uid}
		WHERE hr.room_id=#{room_id} AND h.house_id=#{house_id}
	</update>
	<!-- 当前房源下的所有出租房间 -->
	<select id="selectListByHouseIdContractId" parameterType="java.lang.String" resultType="com.isz.erp.facade.house.entity.HouseRoom">
		SELECT hr.*,h.property_name FROM house_room hr INNER JOIN apartment a ON a.room_id=hr.room_id
		inner join house h on h.house_id = a.house_id and h.deleted=0
		WHERE a.house_id=#{house_id} AND a.house_contract_id=#{contract_id}
		AND hr.deleted=0 AND hr.is_active='Y' AND hr.public_flag='N'
	</select>
	<!-- 整租房源的公共区域和卧室 -->
	<select id="selectByEntireHouseIdAndPublicFlag" parameterType="java.util.Map" resultType="com.isz.erp.facade.house.entity.HouseRoom">
		SELECT * FROM house_room WHERE house_id=#{house_id} AND deleted=0 AND is_active='Y' AND public_flag=#{public_flag}
		<if test="null != contract_id and '' != contract_id">
			AND house_contract_id=#{contract_id}
		</if>
		ORDER BY create_time DESC LIMIT 1
	</select>
	<!-- 合租房源的公共区域和卧室 -->
	<select id="selectByShareHouseIdAndPublicFlag" parameterType="java.util.Map" resultType="com.isz.erp.facade.house.entity.HouseRoom">
		SELECT * FROM house_room WHERE house_id=#{house_id} AND deleted=0 AND is_active='Y' AND public_flag=#{public_flag}
		<if test="null != contract_id and '' != contract_id">
			AND house_contract_id=#{contract_id}
		</if>
		<if test="null != room_no and '' != room_no">
			AND room_no=#{room_no}
		</if>
		ORDER BY create_time DESC LIMIT 1
	</select>
	<!-- 根据装修房间查询出租房间 -->
	<select id="selectByFitmentRoomId" parameterType="java.util.Map" resultType="com.isz.erp.facade.house.entity.HouseRoom">
		SELECT * FROM house_room WHERE fitment_room_id=#{fitment_room_id} ORDER BY create_time DESC LIMIT 1
	</select>

	<select id="selectRoomIdsByFitmentId" parameterType="java.lang.String" resultType="java.lang.String">
		SELECT GROUP_CONCAT(hr.room_id) FROM house_room hr
		INNER JOIN fitment_house fh ON fh.contract_id=hr.house_contract_id AND fh.house_id=hr.house_id
		WHERE fh.fitment_id=#{fitment_id}
	</select>

	<select id="selectByMap" parameterType="java.util.Map" resultType="com.isz.erp.facade.house.entity.HouseRoom">
		SELECT * FROM house_room hr INNER JOIN fitment_house fh ON hr.house_id=fh.house_id
		WHERE fh.fitment_id=#{fitment_id}
		<if test="null != public_flag and '' != public_flag">
			AND hr.public_flag=#{public_flag}
		</if>
		<if test="null != room_no and '' != room_no">
			AND hr.room_no=#{room_no}
		</if>
		ORDER BY hr.create_time DESC LIMIT 1
	</select>
</mapper>