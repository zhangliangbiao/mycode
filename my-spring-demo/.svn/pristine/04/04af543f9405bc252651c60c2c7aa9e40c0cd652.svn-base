<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.isz.erp.house.mapper.BusinessCircleMapper">
	
	<!-- 查询商圈信息 -->
	<select id="sercherTtbudinessCircleList" resultType="com.isz.erp.facade.house.entity.BusinessCircle">
	   SELECT t.business_circle_id,t.business_circle_name,t.is_active,t.create_time,t.create_uid,t.update_time,t.update_uid FROM business_circle AS t
	</select>
	
	
	<select id="selectBusidessCircleByResiId"  parameterType="java.lang.String" resultType="com.isz.erp.facade.house.entity.BusinessCircle">
	   SELECT t.business_circle_id,t.business_circle_name,t.is_active,t.create_time,t.create_uid,t.update_time,t.update_uid 
	   FROM business_circle t WHERE t.business_circle_id in(
       SELECT a.business_circle_id FROM residential_business_circle a WHERE a.residential_id = #{residential_id})
	
	</select>
	
	<select id="sercherBudinessCircleByCode" parameterType="java.util.Map" resultType="com.isz.erp.facade.house.entity.BusinessCircle">
	    SELECT t.business_circle_id,t.business_circle_name,t.is_active,t.create_time,t.create_uid,t.update_time,t.update_uid 
		FROM business_circle AS t 
		LEFT JOIN business_circle_district As b 
		ON t.business_circle_id = b.business_circle_id
		<where>
		   <if test="area_code != null and area_code != ''">AND b.area_code in(${area_code})</if>
		   <if test="city_code != null and city_code != ''">AND b.city_code = #{city_code}</if>
		</where>
		GROUP BY t.business_circle_id
	</select>
	
	
	<select id="sercherBudinessCircleByName"  parameterType="java.lang.String" resultType="java.lang.Integer">
	   SELECT count(1)
	   FROM business_circle t WHERE t.business_circle_name = #{business_circle_name}
	</select>
	<select id="sercherBusinessCircleDistrictByName"  parameterType="java.util.Map" resultType="java.lang.Integer">
	   SELECT count(1)
	   FROM business_circle_district t WHERE t.business_circle_id = #{business_circle_id} and t.city_code = #{city_code} and t.area_code = #{area_code}
	</select>
	<insert id="insertBusinessCircleDistrict" parameterType="com.isz.erp.facade.house.entity.BusinessCircleDistrict">
	   insert into business_circle_district values(#{business_circle_district_id},#{business_circle_id},#{city_code},#{area_code})
	</insert>
	<select id="getBudinessCircle" parameterType="java.util.Map" resultType="com.isz.erp.facade.house.entity.BusinessCircle">
	    SELECT t.business_circle_id,t.business_circle_name,t.is_active,t.create_time,t.create_uid,t.update_time,t.update_uid 
		FROM business_circle AS t 
		LEFT JOIN business_circle_district As b 
		ON t.business_circle_id = b.business_circle_id
		<where>
		   <if test="area_code != null and area_code != ''">AND b.area_code in(${area_code})</if>
		   <if test="city_code != null and city_code != ''">AND b.city_code = #{city_code}</if>
		   <if test="business_circle_name != null and business_circle_name != ''">AND t.business_circle_name = #{business_circle_name}</if>
		</where>
		GROUP BY t.business_circle_id
		limit 1
	</select>
	
	<select id="sercherBudinessCircleIdByName" parameterType="java.lang.String" resultType="java.lang.String">
	select business_circle_id from business_circle  where business_circle_name = #{0}
	
	</select>

	<select id="searchBusinessCircleList" parameterType="java.util.Map" resultType="java.util.Map">
		select
			(select `name` from sys_district where `code`=bcd.city_code) city_name,
			(select `name` from sys_district where `code`=bcd.area_code) area_name,
			bc.*
		from business_circle bc, business_circle_district bcd
		<include refid="searchBusinessCircleSQL"></include>
	</select>

	<select id="countSearchBusinessCircle" parameterType="java.util.Map" resultType="java.lang.Integer">
		select count(1) from business_circle bc, business_circle_district bcd
		<include refid="searchBusinessCircleSQL"></include>
	</select>
	
	<sql id="searchBusinessCircleSQL">
		where bc.business_circle_id=bcd.business_circle_id
		<if test="null != city_code and '' != city_code">
			and bcd.city_code=#{city_code}
		</if>
		<if test="null != area_code and '' != area_code">
			and bcd.area_code=#{area_code}
		</if>
		<if test="null != business_circle_name_search and '' != business_circle_name_search">
			and bc.business_circle_name like CONCAT('%','${business_circle_name_search}','%' )
		</if>
		<if test="null != business_circle_name and '' != business_circle_name">
			and bc.business_circle_name=#{business_circle_name}
		</if>
		<if test="null != spell and '' != spell">
			and bc.spell=#{spell}
		</if>
	</sql>

	<select id="selectByParams" parameterType="java.util.Map" resultType="com.isz.erp.facade.house.entity.BusinessCircle">
		select bc.*
		from business_circle bc, business_circle_district bcd
		<include refid="searchBusinessCircleSQL"></include>
		limit 1
	</select>

	<select id="selectCountCustomerBusinessCircleByBusinessCircleId" parameterType="java.lang.String" resultType="java.lang.Integer">
		select count(1) from customer_business_circle cbc, customer c
		where cbc.customer_id=c.customer_id and c.deleted=0 and cbc.business_circle_id=#{business_circle_id} limit 1
	</select>

	<select id="selectCountResidentialBusinessCircleByBusinessCircleId" parameterType="java.lang.String" resultType="java.lang.Integer">
		select count(1) from residential_business_circle rbc, residential r
		where rbc.residential_id=r.residential_id and r.deleted=0 and rbc.business_circle_id=#{business_circle_id} limit 1
	</select>
</mapper>